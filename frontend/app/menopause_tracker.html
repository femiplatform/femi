<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FEMI ‚Ä¢ Menopause Tracker</title>
  <link rel="stylesheet" href="../assets/app.css" />
  <style>
    .mtHero{
      background: linear-gradient(135deg, rgba(186,230,253,.30), rgba(251,207,232,.22));
      border: 1px solid rgba(17,24,39,.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 14px 40px rgba(0,0,0,.06);
      backdrop-filter: blur(8px);
    }
    .grid2{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 980px){ .grid2{ grid-template-columns: 1.2fr .8fr; } }

    .input, select, textarea{
      width:100%;
      border: 1px solid rgba(2,6,23,.10);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.92);
      outline: none;
    }
    textarea{ min-height: 90px; resize: vertical; }
    .muted2{ opacity:.75; font-size: 12px; }

    .kpiRow{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
    @media (max-width: 680px){ .kpiRow{ grid-template-columns: 1fr; } }
    .big{
      font-size: 28px;
      font-weight: 900;
      background: linear-gradient(135deg, rgba(59,130,246,.88), rgba(236,72,153,.88));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      line-height: 1.1;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(17,24,39,.08);
      background: rgba(255,255,255,.70);
      font-weight: 900;
      white-space: nowrap;
    }
    .pillOk{ border-color: rgba(34,197,94,.25); background: rgba(220,252,231,.85); }
    .pillMid{ border-color: rgba(245,158,11,.25); background: rgba(255,237,213,.9); }
    .pillHigh{ border-color: rgba(239,68,68,.25); background: rgba(254,226,226,.85); }

    /* trackers */
    .trackGrid{ display:grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
    .tCard{ padding: 12px; }
    .tTitle{ font-weight: 900; margin-bottom: 6px; }
    .scale{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 8px;
    }
    .scaleBtn{
      padding: 10px 8px;
      border-radius: 14px;
      border: 1px solid rgba(17,24,39,.08);
      background: rgba(255,255,255,.70);
      cursor:pointer;
      font-weight: 900;
      text-align:center;
      transition: transform .06s ease, background .18s ease, border-color .18s ease;
      user-select:none;
    }
    .scaleBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.92); }
    .scaleBtn.on{
      border-color: rgba(236,72,153,.35);
      background: rgba(251,207,232,.45);
      box-shadow: 0 10px 26px rgba(236,72,153,.10);
    }
    .small{ font-size: 12px; opacity:.8; font-weight: 800; }

    .moodRow{ display:grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 8px; }
    .moodBtn{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding: 12px 10px;
      border-radius: 16px;
      border: 1px solid rgba(17,24,39,.10);
      background: rgba(255,255,255,.70);
      cursor:pointer;
      transition: transform .06s ease, background .18s ease, border-color .18s ease;
      user-select:none;
      font-weight: 900;
    }
    .moodBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.92); }
    .moodBtn.on{
      border-color: rgba(59,130,246,.35);
      background: rgba(219,234,254,.85);
      box-shadow: 0 10px 26px rgba(59,130,246,.10);
    }
    .emoji{ font-size: 26px; line-height: 1; }
    .emojiLbl{ font-size: 12px; opacity:.85; margin-top: 6px; text-align:center; }

    .recent{ display:grid; gap: 10px; margin-top: 10px; }
  </style>
</head>

<body>
  <div id="app">
    <main class="container">
      <h1 class="page-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏¢‡∏ó‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h1>
      <p class="page-sub muted">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡∏£‡πâ‡∏≠‡∏ô‡∏ß‡∏π‡∏ö‡∏ß‡∏≤‡∏ö ‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‡∏Ø‡∏•‡∏Ø) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</p>

      <div class="grid2">
        <!-- Left -->
        <div class="mtHero">
          <div class="card" style="padding:14px;background:rgba(255,255,255,.72);border:1px solid rgba(17,24,39,.08);box-shadow:0 14px 40px rgba(0,0,0,.06);">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
              <div>
                <div style="font-weight:900;font-size:16px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="muted2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 0‚Äì3 ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button id="btnResetToday" class="btn btn-ghost">‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                <button id="btnSave" class="btn btn-ok">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              </div>
            </div>

            <div class="grid2" style="margin-top:10px">
              <div>
                <label class="muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input id="date" class="input" type="date" />
              </div>
              <div>
                <label class="muted">‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                <select id="cycle" class="input">
                  <option value="normal">‡∏¢‡∏±‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠</option>
                  <option value="irregular">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠</option>
                  <option value="stopped_lt12">‡∏Ç‡∏≤‡∏î &lt; 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                  <option value="stopped_ge12">‡∏Ç‡∏≤‡∏î ‚â• 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                </select>
              </div>
            </div>

            <div style="margin-top:10px">
              <div style="font-weight:900">‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</div>
              <div class="muted2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥</div>
              <div class="moodRow" id="moodRow"></div>
            </div>

            <div class="trackGrid" id="trackGrid"></div>

            <div style="margin-top:10px">
              <label class="muted">‡πÇ‡∏ô‡πâ‡∏ï</label>
              <textarea id="note" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏≠‡∏≤‡∏Å‡∏≤‡∏®/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î), ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ ‡∏Ø‡∏•‡∏Ø"></textarea>
            </div>

            <div class="kpiRow">
              <div class="card-soft" style="padding:12px">
                <div class="muted">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 7 ‡∏ß‡∏±‡∏ô</div>
                <div class="big" id="kAvg7">-</div>
                <div class="muted2" id="kAvg7Text">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
              </div>
              <div class="card-soft" style="padding:12px">
                <div class="muted">‡πÅ‡∏¢‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 30 ‡∏ß‡∏±‡∏ô</div>
                <div class="big" id="kWorst">-</div>
                <div class="muted2" id="kWorstText">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
              </div>
              <div class="card-soft" style="padding:12px">
                <div class="muted">‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                <div class="big" id="kMood">-</div>
                <div class="muted2" id="kMoodText">‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
              </div>
            </div>

            <div class="actions" style="margin-top:10px">
              <button id="btnExport" class="btn btn-ghost">Export CSV</button>
              <button id="btnClearAll" class="btn btn-ghost">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>

            <div class="card-soft" style="padding:12px;margin-top:12px">
              <div style="font-weight:900">‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏´‡∏≤‡∏Å</div>
              <div class="muted" style="margin-top:8px;line-height:1.7">
                ‚Ä¢ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏ô‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏•‡∏≥‡∏ö‡∏≤‡∏Å ‚Ä¢ ‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏Å ‚Ä¢ ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏¢‡πà‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á<br>
                ‚Ä¢ ‡πÄ‡∏à‡πá‡∏ö‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å/‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏•‡∏≥‡∏ö‡∏≤‡∏Å ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
              </div>
            </div>
          </div>

          <div class="card" style="padding:14px;margin-top:12px">
            <div style="font-weight:900;font-size:16px">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            <div class="muted2" style="margin-top:6px">10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
            <div id="recent" class="recent"></div>
          </div>
        </div>

        <!-- Right -->
        <div>
          <div class="card" style="padding:14px">
            <div style="font-weight:900;font-size:16px">‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏î‡∏π‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</div>
            <div class="muted" style="margin-top:8px;line-height:1.7">
              ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á: ‡∏•‡∏≠‡∏á‡∏´‡∏≤ ‚Äú‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‚Äù (‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î/‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô/‡∏≠‡∏≤‡∏Å‡∏≤‡∏®)<br>
              ‚Ä¢ ‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° 1‚Äì2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå<br>
              ‚Ä¢ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            </div>
          </div>

          <div class="card" style="padding:14px;margin-top:12px">
            <div style="font-weight:900;font-size:16px">‡∏ó‡∏¥‡∏õ‡∏™‡∏±‡πâ‡∏ô ‡πÜ</div>
            <div class="muted" style="margin-top:8px;line-height:1.7">
              ‚Ä¢ ‡∏£‡πâ‡∏≠‡∏ô‡∏ß‡∏π‡∏ö‡∏ß‡∏≤‡∏ö: ‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏±‡πâ‡∏ô ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ä‡πâ‡∏≤ ‡∏•‡∏î‡πÄ‡∏ú‡πá‡∏î/‡∏Ñ‡∏≤‡πÄ‡∏ü‡∏≠‡∏µ‡∏ô<br>
              ‚Ä¢ ‡∏ô‡∏≠‡∏ô: ‡∏•‡∏î‡∏à‡∏≠ 1 ‡∏ä‡∏°.‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô ‡∏à‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏¢‡πá‡∏ô‡∏™‡∏ö‡∏≤‡∏¢<br>
              ‚Ä¢ ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå: ‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢/‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á/‡∏ó‡∏≥‡∏™‡∏°‡∏≤‡∏ò‡∏¥ ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script type="module">
    import { initUserShell } from "../js/shell.js";
    import { applyI18n } from "../js/i18n.js";

    await initUserShell({ active: "tools", title: "Menopause Tracker" });
    try{ applyI18n(document); }catch{}

    const LS_KEY = "FEMI_MENOPAUSE_TRACKER_V1";

    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : { entries: [] };
      }catch{
        return { entries: [] };
      }
    }
    function save(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

    function isoToday(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function nowTs(){ return Date.now(); }
    function toDate(iso){ return new Date(iso + "T00:00:00"); }

    const dateEl = document.getElementById("date");
    const cycleEl = document.getElementById("cycle");
    const noteEl = document.getElementById("note");

    const moodRow = document.getElementById("moodRow");
    const trackGrid = document.getElementById("trackGrid");

    const btnResetToday = document.getElementById("btnResetToday");
    const btnSave = document.getElementById("btnSave");
    const btnExport = document.getElementById("btnExport");
    const btnClearAll = document.getElementById("btnClearAll");

    const kAvg7 = document.getElementById("kAvg7");
    const kAvg7Text = document.getElementById("kAvg7Text");
    const kWorst = document.getElementById("kWorst");
    const kWorstText = document.getElementById("kWorstText");
    const kMood = document.getElementById("kMood");
    const kMoodText = document.getElementById("kMoodText");

    const recentEl = document.getElementById("recent");

    const MOODS = [
      { id: 5, emoji:"üòÑ", label:"‡∏î‡∏µ‡∏°‡∏≤‡∏Å" },
      { id: 4, emoji:"üôÇ", label:"‡∏î‡∏µ" },
      { id: 3, emoji:"üòê", label:"‡πÄ‡∏â‡∏¢ ‡πÜ" },
      { id: 2, emoji:"üòü", label:"‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏µ" },
      { id: 1, emoji:"üò¢", label:"‡πÅ‡∏¢‡πà" },
    ];

    const TRACKS = [
      { id:"hotflash", name:"‡∏£‡πâ‡∏≠‡∏ô‡∏ß‡∏π‡∏ö‡∏ß‡∏≤‡∏ö/‡πÄ‡∏´‡∏á‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô" },
      { id:"sleep", name:"‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô" },
      { id:"moodSym", name:"‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î/‡∏ß‡∏¥‡∏ï‡∏Å‡∏Å‡∏±‡∏á‡∏ß‡∏•" },
      { id:"fatigue", name:"‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢" },
      { id:"joint", name:"‡∏õ‡∏ß‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏Ç‡πâ‡∏≠" },
      { id:"vaginal", name:"‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏•‡∏≠‡∏î‡πÅ‡∏´‡πâ‡∏á/‡πÄ‡∏à‡πá‡∏ö" },
      { id:"urinary", name:"‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞/‡∏Å‡∏•‡∏±‡πâ‡∏ô‡∏¢‡∏≤‡∏Å" },
    ];

    let state = load();
    let selectedMood = null;
    let scores = {}; // track id -> 0..3

    function renderMood(){
      moodRow.innerHTML = MOODS.map(m=>`
        <div class="moodBtn" data-mood="${m.id}">
          <div class="emoji">${m.emoji}</div>
          <div class="emojiLbl">${m.label}</div>
        </div>
      `).join("");

      moodRow.querySelectorAll(".moodBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          moodRow.querySelectorAll(".moodBtn").forEach(x=>x.classList.remove("on"));
          btn.classList.add("on");
          selectedMood = Number(btn.getAttribute("data-mood"));
        });
      });
    }

    function renderTracks(){
      trackGrid.innerHTML = TRACKS.map(t=>{
        const current = Number(scores[t.id] ?? 0);
        return `
          <div class="card tCard">
            <div class="tTitle">${escapeHtml(t.name)}</div>
            <div class="muted2">0=‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Ä¢ 1=‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‚Ä¢ 2=‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‚Ä¢ 3=‡∏°‡∏≤‡∏Å</div>
            <div class="scale" data-track="${t.id}">
              ${[0,1,2,3].map(v=>`
                <div class="scaleBtn ${v===current ? "on":""}" data-v="${v}">
                  ${v}
                  <div class="small">${v===0?"‡πÑ‡∏°‡πà‡∏°‡∏µ":v===1?"‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢":v===2?"‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á":"‡∏°‡∏≤‡∏Å"}</div>
                </div>
              `).join("")}
            </div>
          </div>
        `;
      }).join("");

      trackGrid.querySelectorAll(".scale").forEach(row=>{
        row.querySelectorAll(".scaleBtn").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = row.getAttribute("data-track");
            const v = Number(btn.getAttribute("data-v"));
            scores[id] = v;
            row.querySelectorAll(".scaleBtn").forEach(x=>x.classList.remove("on"));
            btn.classList.add("on");
          });
        });
      });
    }

    function moodLabel(id){
      const m = MOODS.find(x=>x.id===id);
      return m ? `${m.emoji} ${m.label}` : "-";
    }

    function totalScore(entry){
      const s = entry.scores || {};
      return TRACKS.reduce((acc,t)=> acc + (Number(s[t.id]||0)), 0);
    }

    function upsertEntry(){
      const d = dateEl.value || isoToday();
      if(!selectedMood) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        return;
      }
      const entry = {
        date: d,
        cycle: cycleEl.value || "normal",
        mood: selectedMood,
        scores: { ...scores },
        note: (noteEl.value || "").trim(),
        updatedAt: nowTs()
      };

      // upsert by date
      const idx = (state.entries||[]).findIndex(e => e.date === d);
      if(idx >= 0) state.entries[idx] = entry;
      else state.entries = [entry, ...(state.entries||[])];

      // sort desc by date
      state.entries.sort((a,b)=> b.date.localeCompare(a.date));
      // keep 180
      state.entries = state.entries.slice(0, 180);

      save(state);
      renderAll();
      toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
    }

    function resetToday(){
      selectedMood = null;
      scores = {};
      noteEl.value = "";
      cycleEl.value = "normal";
      moodRow.querySelectorAll(".moodBtn").forEach(x=>x.classList.remove("on"));
      renderTracks();
    }

    btnSave.addEventListener("click", upsertEntry);
    btnResetToday.addEventListener("click", resetToday);

    btnClearAll.addEventListener("click", ()=>{
      if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")){
        state = { entries: [] };
        save(state);
        renderAll();
        resetToday();
      }
    });

    function renderKPIs(){
      const entries = (state.entries || []).slice().sort((a,b)=> b.date.localeCompare(a.date));
      if(!entries.length){
        kAvg7.textContent = "-";
        kWorst.textContent = "-";
        kMood.textContent = "-";
        kAvg7Text.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        kWorstText.textContent = "‚Äî";
        kMoodText.textContent = "‚Äî";
        return;
      }

      // last 7 days by date order
      const last7 = entries.slice(0, 7);
      const avg = last7.reduce((acc,e)=> acc + totalScore(e), 0) / last7.length;
      kAvg7.textContent = String(Math.round(avg * 10) / 10);

      // worst in last 30 entries or 30 days approximation
      const last30 = entries.slice(0, 30);
      let worst = last30[0];
      for(const e of last30){
        if(totalScore(e) > totalScore(worst)) worst = e;
      }
      kWorst.textContent = String(totalScore(worst));
      kWorstText.textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${worst.date}`;

      const latest = entries[0];
      kMood.textContent = String(latest.mood);
      kMoodText.textContent = moodLabel(latest.mood);
    }

    function renderRecent(){
      const entries = (state.entries || []).slice(0, 10);
      if(!entries.length){
        recentEl.innerHTML = '<div class="muted2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
        return;
      }
      recentEl.innerHTML = entries.map(e=>{
        const total = totalScore(e);
        let pill = { cls:"pill pillOk", text:"‡πÄ‡∏ö‡∏≤" };
        if(total >= 12) pill = { cls:"pill pillHigh", text:"‡∏°‡∏≤‡∏Å" };
        else if(total >= 6) pill = { cls:"pill pillMid", text:"‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á" };

        return `
          <div class="card" style="padding:12px">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
              <div style="min-width:0">
                <div style="font-weight:900">${e.date}</div>
                <div class="muted2">‡∏£‡∏ß‡∏°: ${total} ‚Ä¢ ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå: ${escapeHtml(moodLabel(e.mood))} ‚Ä¢ ‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${escapeHtml(e.cycle||"-")}</div>
              </div>
              <span class="${pill.cls}">${pill.text}</span>
            </div>
            ${e.note ? `<div class="muted2" style="margin-top:6px">‡πÇ‡∏ô‡πâ‡∏ï: ${escapeHtml(e.note)}</div>` : ""}
            <div class="actions" style="margin-top:10px">
              <button class="btn btn-ghost" data-load="${e.date}">‡πÇ‡∏´‡∏•‡∏î</button>
              <button class="btn btn-ghost" data-del="${e.date}">‡∏•‡∏ö</button>
            </div>
          </div>
        `;
      }).join("");

      recentEl.querySelectorAll("[data-del]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const d = b.getAttribute("data-del");
          if(confirm(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d} ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)){
            state.entries = (state.entries || []).filter(x => x.date !== d);
            save(state);
            renderAll();
          }
        });
      });

      recentEl.querySelectorAll("[data-load]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const d = b.getAttribute("data-load");
          const rec = (state.entries || []).find(x => x.date === d);
          if(!rec) return;

          dateEl.value = rec.date;
          cycleEl.value = rec.cycle || "normal";
          noteEl.value = rec.note || "";
          scores = rec.scores || {};
          selectedMood = rec.mood || null;

          // render mood selection
          moodRow.querySelectorAll(".moodBtn").forEach(x=>x.classList.remove("on"));
          if(selectedMood){
            const btn = moodRow.querySelector(`.moodBtn[data-mood="${selectedMood}"]`);
            if(btn) btn.classList.add("on");
          }
          renderTracks();
          toast("‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß");
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      });
    }

    function renderAll(){
      renderKPIs();
      renderRecent();
    }

    btnExport.addEventListener("click", ()=>{
      const header = ["date","cycle","mood","moodLabel","total","note"].concat(TRACKS.map(t=>t.id));
      const rows = [header];
      const entries = (state.entries || []).slice().sort((a,b)=> a.date.localeCompare(b.date));
      for(const e of entries){
        const row = [
          e.date,
          e.cycle || "",
          String(e.mood || ""),
          moodLabel(e.mood || 0),
          String(totalScore(e)),
          (e.note || "").replaceAll("\n"," "),
        ];
        for(const t of TRACKS){
          row.push(String((e.scores||{})[t.id] ?? 0));
        }
        rows.push(row);
      }
      const csv = rows.map(r => r.map(x=>{
        const s = String(x ?? "");
        const safe = s.includes(",") || s.includes('"') || s.includes("\n") ? '"' + s.replaceAll('"','""') + '"' : s;
        return safe;
      }).join(",")).join("\n");

      const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "menopause_tracker.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 500);
    });

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // toast
    let toastTimer = null;
    function toast(msg){
      clearTimeout(toastTimer);
      let el = document.getElementById("__toast");
      if(!el){
        el = document.createElement("div");
        el.id = "__toast";
        el.style.position = "fixed";
        el.style.left = "50%";
        el.style.bottom = "18px";
        el.style.transform = "translateX(-50%)";
        el.style.padding = "10px 12px";
        el.style.borderRadius = "999px";
        el.style.border = "1px solid rgba(17,24,39,.10)";
        el.style.background = "rgba(255,255,255,.92)";
        el.style.boxShadow = "0 12px 30px rgba(0,0,0,.14)";
        el.style.fontWeight = "900";
        el.style.zIndex = "80";
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.opacity = "1";
      toastTimer = setTimeout(()=>{ el.style.opacity = "0"; }, 1600);
    }

    // init
    state = load();
    dateEl.value = isoToday();
    renderMood();
    renderTracks();
    renderAll();
  </script>
</body>
</html>
