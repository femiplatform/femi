<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FEMI ‚Ä¢ Home</title>
  <link rel="stylesheet" href="../assets/app.css"/>

  <style>
    /* News ticker */
    #tickerBox{ border:1px solid rgba(17,24,39,.08); background: rgba(255,255,255,.72); }
    .femiTickerTrack{
      display:inline-block;
      white-space:nowrap;
      will-change: transform;
      animation: femiTicker 28s linear infinite;
      padding-left: 100%;
    }
    @keyframes femiTicker{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-100%); }
    }
    @media (prefers-reduced-motion: reduce){
      .femiTickerTrack{ animation:none; padding-left:0; }
    }
  </style>

</head>
<body>
  <div id="app">
    <main class="container">      <p class="page-sub muted"><span data-i18n="home.welcome">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</span> üëã <span id="welcomeName" style="font-weight:900"></span></p>

      <div class="card-soft" id="tickerBox" style="padding:10px 12px;margin-top:10px;overflow:hidden">
        <div style="display:flex;align-items:center;gap:10px">
          <span class="badge-soft" style="white-space:nowrap">‡∏Ç‡πà‡∏≤‡∏ß/‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</span>
          <div style="position:relative;flex:1;overflow:hidden">
            <div id="newsTicker" class="femiTickerTrack">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß...</div>
          </div>
        </div>
      </div>

      <!-- Summary card -->
      <div class="card" style="padding:14px">
        <div style="font-weight:900" data-i18n="home.summaryTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>

        <div class="grid-2" style="margin-top:10px">
          <!-- FP -->
          <div class="card summary fp" style="padding:12px;box-shadow:none">
            <div style="font-weight:900" data-i18n="home.fpCardTitle">‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
            <div class="muted" id="fpSummary" style="margin-top:6px">-</div>
            <div class="muted" id="fpDetail" style="margin-top:6px;line-height:1.5"></div>
            <div style="margin-top:10px">
              <a class="pill pill-fp" href="./family_planning.html">‡πÑ‡∏õ‡∏ó‡∏µ‡πà ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</a>
            </div>
          </div>

          <!-- Preventive -->
          <div class="card summary pv" style="padding:12px;box-shadow:none">
            <div style="font-weight:900" data-i18n="home.pvCardTitle">‡∏á‡∏≤‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
            <div style="display:flex;justify-content:space-between;margin-top:10px">
              <span class="muted" data-i18n="home.pvDueToday">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
              <b id="pvDue">-</b>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px">
              <span class="muted" data-i18n="home.pvOverdue">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
              <b id="pvOver">-</b>
            </div>
            <div style="margin-top:10px">
              <a class="pill pill-pv" href="./preventive.html">‡πÑ‡∏õ‡∏ó‡∏µ‡πà ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô</a>
            </div>
          </div>

          <!-- Notifications -->
          <div class="card summary noti" style="padding:12px;box-shadow:none">
            <div style="font-weight:900" data-i18n="home.notiCardTitle">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
            <div style="display:flex;justify-content:space-between;margin-top:10px">
              <span class="muted" data-i18n="home.notiUnread">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô</span>
              <b id="notiUnread">-</b>
            </div>
            <div style="margin-top:10px">
              <a class="pill pill-noti" href="./notifications.html" data-i18n="nav.notifications">‡πÑ‡∏õ‡∏ó‡∏µ‡πà ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô1</a>
            </div>
          </div>

          <!-- Quiz -->
          <div class="card summary quiz" style="padding:12px;box-shadow:none">
            <div style="font-weight:900">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
            <div class="muted" style="margin-top:6px">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            <div style="font-size:26px;font-weight:1000;margin-top:2px" id="quizLast">-</div>
            <div class="muted" style="font-size:12px" id="quizHint">-</div>
            <div style="margin-top:10px">
              <a class="pill pill-quiz" href="./quiz.html">‡πÑ‡∏õ‡∏ó‡∏µ‡πà ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</a>
            </div>
          </div>
        </div>
      </div>

      </main>
  </div>

  <script type="module">
    import { initUserShell } from "../js/shell.js";
    import { getSession } from "../js/auth.js";
    import { api } from "../js/api.js";
    import { t, applyI18n } from "../js/i18n.js";
    import { Icons } from "../js/icons.js";

    await initUserShell({ active: "home", title: t("page.home") });
    applyI18n(document);

    // Welcome name (First + Last)
    try{
      const s = getSession();
      const u = s?.user || {};
      const fullName = [u.firstName, u.lastName].filter(Boolean).join(" ").trim();
      const el = document.getElementById("welcomeName");
      if(el) el.textContent = fullName ? fullName : "";
    }catch{}

    // News ticker
    async function loadTicker(){
      const box = document.getElementById("newsTicker");
      if(!box) return;
      try{
        const list = await api.newsList();
        const items = Array.isArray(list) ? list : (Array.isArray(list?.items) ? list.items : []);
        const titles = items
          .filter(x => (x?.title || "").trim())
          .slice(0, 12)
          .map(x => String(x.title).trim());
        const text = titles.length ? titles.join(" ‚Ä¢ ") : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß/‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®";
        // duplicate for seamless loop
        const dup = titles.length ? (text + " ¬†¬†¬†‚Ä¢¬†¬†¬† " + text) : text;
        box.textContent = dup;
      }catch{
        box.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß/‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏î‡πâ";
      }
    }
    loadTicker();

    // summary data
    const fpSummary = document.getElementById("fpSummary");
    const fpDetail = document.getElementById("fpDetail");
    const pvDue = document.getElementById("pvDue");
    const pvOver = document.getElementById("pvOver");
    const notiUnread = document.getElementById("notiUnread");
    const quizLast = document.getElementById("quizLast");
    const quizHint = document.getElementById("quizHint");

    const fmtThai = (iso) => iso ? new Date(iso).toLocaleDateString("th-TH",{dateStyle:"long"}) : "-";

    // FP summary (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)
    const FP_LS_KEY = "FEMI_FAMILY_PLANNING_LOCAL_V2"; // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ family_planning.html ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
    const pad2 = (n)=>String(n).padStart(2,"0");
    const iso = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const addDays = (isoStr, days)=>{
      const d = new Date(isoStr + "T00:00:00");
      d.setDate(d.getDate()+days);
      return iso(d);
    };
    const readFpLocal = ()=>{
      try{
        const raw = localStorage.getItem(FP_LS_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch{ return null; }
    };
    const fpCompute = (st)=>{
      const cycles = Array.isArray(st?.cycles) ? st.cycles : [];
      if(!cycles.length) return null;
      // latest by start date desc
      const latest = cycles.slice().sort((a,b)=>String(b.start||"").localeCompare(String(a.start||"")))[0];
      const start = latest.start;
      const cycleLen = Number(latest.cycleLen||latest.cycleLengthDays||st?.settings?.cycleLen||28) || 28;
      const periodLen = Number(latest.periodLen||latest.periodLengthDays||st?.settings?.periodLen||5) || 5;
      const nextStart = addDays(start, Math.round(cycleLen));
      const ovulation = addDays(nextStart, -14);
      const fertileStart = addDays(ovulation, -5);
      const fertileEnd = ovulation;
      return { start, cycleLen, periodLen, nextStart, ovulation, fertileStart, fertileEnd };
    };

    try{
      const st = readFpLocal();
      const p = st ? fpCompute(st) : null;
      if(!p){
        fpSummary.textContent = t("home.fpNoData");
        fpDetail.textContent = "";
      } else {
        fpSummary.textContent = "‚úÖ " + t("home.fpCardTitle");
        fpDetail.innerHTML =
          `${t("home.fpNextPeriod")} <b>${fmtThai(p.nextStart)}</b><br/>` +
          `${t("home.fpOvulation")} <b>${fmtThai(p.ovulation)}</b><br/>` +
          `${t("home.fpFertile")} <b>${fmtThai(p.fertileStart)} ‚Äì ${fmtThai(p.fertileEnd)}</b>`;
      }
    }catch{
      fpSummary.textContent = t("home.fpNoData");
      fpDetail.textContent = "";
    }

    // Preventive counts
    try{
      const pv = await api.preventiveList();
      pvDue.textContent = pv?.counts?.dueToday ?? "-";
      pvOver.textContent = pv?.counts?.overdue ?? "-";
    }catch{
      pvDue.textContent = "-";
      pvOver.textContent = "-";
    }

    // Notifications unread
    try{
      const u = await api.userNotificationsUnreadCount();
      notiUnread.textContent = (u?.unread ?? 0);
    }catch{
      notiUnread.textContent = "-";
    }

    // Quiz last score
    try{
      const res = await api.quizMyResults();
      const arr = Array.isArray(res) ? res : (Array.isArray(res?.items) ? res.items : []);
      const last = arr[0] || null;
      quizLast.textContent = last ? `${last.score}/${last.total}` : "-";
      quizHint.textContent = last
        ? (last.takenAt ? new Date(last.takenAt).toLocaleString("th-TH",{dateStyle:"medium",timeStyle:"short"}) : "")
        : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö";
    }catch{
      quizLast.textContent = "-";
      quizHint.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö";
    }
  </script>
</body>
</html>