<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FEMI ‚Ä¢ Home</title>
  <link rel="stylesheet" href="../assets/app.css"/>
</head>
<body>
  <div id="app">
    <main class="container">
      <h1 class="page-title" data-i18n="page.home">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</h1>
      <p class="page-sub muted"><span data-i18n="home.welcome">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</span> üëã</p>

      <!-- Summary card -->
      <div class="card" style="padding:14px">
        <div style="font-weight:900" data-i18n="home.summaryTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>

        <div class="grid2" style="margin-top:10px">
          <!-- FP -->
          <div class="card summary fp" style="padding:12px;box-shadow:none">
            <div style="font-weight:900" data-i18n="home.fpCardTitle">‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
            <div class="muted" id="fpSummary" style="margin-top:6px">-</div>
            <div class="muted" id="fpDetail" style="margin-top:6px;line-height:1.5"></div>
            <div style="margin-top:10px">
              <a class="pill pill-fp" href="./family_planning.html">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</a>
            </div>
          </div>

          <!-- Preventive -->
          <div class="card summary pv" style="padding:12px;box-shadow:none">
            <div style="font-weight:900" data-i18n="home.pvCardTitle">‡∏á‡∏≤‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
            <div style="display:flex;justify-content:space-between;margin-top:10px">
              <span class="muted" data-i18n="home.pvDueToday">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
              <b id="pvDue">-</b>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px">
              <span class="muted" data-i18n="home.pvOverdue">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
              <b id="pvOver">-</b>
            </div>
            <div style="margin-top:10px">
              <a class="pill pill-pv" href="./preventive.html">‡πÑ‡∏õ‡∏ó‡∏µ‡πà Preventive</a>
            </div>
          </div>

          <!-- Notifications -->
          <div class="card summary noti" style="padding:12px;box-shadow:none">
            <div style="font-weight:900" data-i18n="home.notiCardTitle">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
            <div style="display:flex;justify-content:space-between;margin-top:10px">
              <span class="muted" data-i18n="home.notiUnread">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô</span>
              <b id="notiUnread">-</b>
            </div>
            <div style="margin-top:10px">
              <a class="pill pill-noti" href="./notifications.html" data-i18n="nav.notifications">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</a>
            </div>
          </div>

          <!-- Quiz -->
          <div class="card summary quiz" style="padding:12px;box-shadow:none">
            <div style="font-weight:900">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
            <div class="muted" style="margin-top:6px">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            <div style="font-size:26px;font-weight:1000;margin-top:2px" id="quizLast">-</div>
            <div class="muted" style="font-size:12px" id="quizHint">-</div>
            <div style="margin-top:10px">
              <a class="pill pill-quiz" href="./quiz.html">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick tiles -->
      <div class="card" style="padding:14px;margin-top:12px">
        <div style="font-weight:900" data-i18n="home.quickActions">‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î</div>

        <div class="tiles">
          <a class="tile pv" href="./preventive.html">
            <div class="left">
              <div class="iconWrap" id="icPv"></div>
              <div style="min-width:0">
                <div class="title">‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
                <div class="sub">Preventive</div>
              </div>
            </div>
            <span class="badge-soft">‚Ä∫</span>
          </a>

          <a class="tile fp" href="./family_planning.html">
            <div class="left">
              <div class="iconWrap" id="icFp"></div>
              <div style="min-width:0">
                <div class="title">‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</div>
                <div class="sub">Family Planning</div>
              </div>
            </div>
            <span class="badge-soft">‚Ä∫</span>
          </a>

          <a class="tile kb" href="./knowledge.html">
            <div class="left">
              <div class="iconWrap" id="icKb"></div>
              <div style="min-width:0">
                <div class="title">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</div>
                <div class="sub">Knowledge</div>
              </div>
            </div>
            <span class="badge-soft">‚Ä∫</span>
          </a>

          <a class="tile qz" href="./quiz.html">
            <div class="left">
              <div class="iconWrap" id="icQz"></div>
              <div style="min-width:0">
                <div class="title">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
                <div class="sub">Quiz</div>
              </div>
            </div>
            <span class="badge-soft">‚Ä∫</span>
          </a>

          <a class="tile noti" href="./notifications.html">
            <div class="left">
              <div class="iconWrap" id="icNt"></div>
              <div style="min-width:0">
                <div class="title">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                <div class="sub">Notifications</div>
              </div>
            </div>
            <span class="badge-soft">‚Ä∫</span>
          </a>

          <a class="tile" href="./dashboard.html">
            <div class="left">
              <div class="iconWrap" id="icDb"></div>
              <div style="min-width:0">
                <div class="title">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
                <div class="sub">Dashboard</div>
              </div>
            </div>
            <span class="badge-soft">‚Ä∫</span>
          </a>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { initUserShell } from "../js/shell.js";
    import { api } from "../js/api.js";
    import { t, applyI18n } from "../js/i18n.js";
    import { Icons } from "../js/icons.js";

    await initUserShell({ active: "home", title: t("page.home") });
    applyI18n(document);

    // icons (tiles)
    document.getElementById("icPv").innerHTML = Icons.heartShield();
    document.getElementById("icFp").innerHTML = Icons.calendar();
    document.getElementById("icKb").innerHTML = Icons.book();
    document.getElementById("icQz").innerHTML = Icons.quiz();
    document.getElementById("icNt").innerHTML = Icons.noti();
    document.getElementById("icDb").innerHTML = Icons.dashboard();

    // summary data
    const fpSummary = document.getElementById("fpSummary");
    const fpDetail = document.getElementById("fpDetail");
    const pvDue = document.getElementById("pvDue");
    const pvOver = document.getElementById("pvOver");
    const notiUnread = document.getElementById("notiUnread");
    const quizLast = document.getElementById("quizLast");
    const quizHint = document.getElementById("quizHint");

    const fmtThai = (iso) => iso ? new Date(iso).toLocaleDateString("th-TH",{dateStyle:"long"}) : "-";

    // FP latest prediction
    try{
      const pred = await api.fpPredLatest();
      const item = pred?.item || null;
      if(!item){
        fpSummary.textContent = t("home.fpNoData");
        fpDetail.textContent = "";
      } else {
        fpSummary.textContent = "‚úÖ " + t("home.fpCardTitle");
        fpDetail.innerHTML =
          `${t("home.fpNextPeriod")} <b>${fmtThai(item.nextPeriodExpectedDate)}</b><br/>` +
          `${t("home.fpOvulation")} <b>${fmtThai(item.ovulationDate)}</b><br/>` +
          `${t("home.fpFertile")} <b>${fmtThai(item.fertileStartDate)} ‚Äì ${fmtThai(item.fertileEndDate)}</b>`;
      }
    }catch{
      fpSummary.textContent = t("home.fpNoData");
      fpDetail.textContent = "";
    }

    // Preventive counts
    try{
      const pv = await api.preventiveList();
      pvDue.textContent = pv?.counts?.dueToday ?? "-";
      pvOver.textContent = pv?.counts?.overdue ?? "-";
    }catch{
      pvDue.textContent = "-";
      pvOver.textContent = "-";
    }

    // Notifications unread
    try{
      const u = await api.userNotificationsUnreadCount();
      notiUnread.textContent = (u?.unread ?? 0);
    }catch{
      notiUnread.textContent = "-";
    }

    // Quiz last score
    try{
      const res = await api.quizMyResults();
      const arr = Array.isArray(res) ? res : (Array.isArray(res?.items) ? res.items : []);
      const last = arr[0] || null;
      quizLast.textContent = last ? `${last.score}/${last.total}` : "-";
      quizHint.textContent = last
        ? (last.takenAt ? new Date(last.takenAt).toLocaleString("th-TH",{dateStyle:"medium",timeStyle:"short"}) : "")
        : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö";
    }catch{
      quizLast.textContent = "-";
      quizHint.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö";
    }
  </script>
</body>
</html>