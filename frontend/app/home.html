<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FEMI ‚Ä¢ Home</title>
  <link rel="stylesheet" href="../assets/app.css"/>
</head>
<body>
<div id="app">
  <main class="container">
    <h1 data-i18n="page.home">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</h1>
    <p class="muted"><span data-i18n="home.welcome">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</span> üëã</p>

    <!-- Summary -->
    <div class="card" style="padding:14px;margin-top:8px">
      <div style="font-weight:900" data-i18n="home.summaryTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>

      <div class="grid" style="margin-top:10px">
        <div class="subcard">
          <div class="k" data-i18n="home.fpCardTitle">‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
          <div class="muted" id="fpSummary">-</div>
          <div class="muted" id="fpDetail" style="margin-top:6px"></div>
        </div>

        <div class="subcard">
          <div class="k" data-i18n="home.pvCardTitle">‡∏á‡∏≤‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
          <div class="row">
            <span class="muted" data-i18n="home.pvDueToday">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
            <b id="pvDue">-</b>
          </div>
          <div class="row">
            <span class="muted" data-i18n="home.pvOverdue">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
            <b id="pvOver">-</b>
          </div>
        </div>

        <div class="subcard">
          <div class="k" data-i18n="home.notiCardTitle">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
          <div class="row">
            <span class="muted" data-i18n="home.notiUnread">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô</span>
            <b id="notiUnread">-</b>
          </div>
          <a class="link" href="./notifications.html" data-i18n="nav.notifications">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</a>
        </div>
      </div>
    </div>

    <!-- Quick actions -->
    <div class="card" style="padding:14px;margin-top:12px">
      <div style="font-weight:900" data-i18n="home.quickActions">‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î</div>
      <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px">
        <a class="tile" href="./preventive.html" data-i18n="tools.preventive">‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (Preventive)</a>
        <a class="tile" href="./family_planning.html" data-i18n="tools.familyPlanning">‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</a>
        <a class="tile" href="./knowledge.html" data-i18n="tools.knowledge">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</a>
        <a class="tile" href="./quiz.html" data-i18n="tools.quiz">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</a>
      </div>
    </div>
  </main>
</div>

<script type="module">
  import { initUserShell } from "../js/shell.js";
  import { api } from "../js/api.js";
  import { t, applyI18n } from "../js/i18n.js";

  await initUserShell({ active: "home", title: t("page.home") });
  applyI18n(document);

  const fpSummary = document.getElementById("fpSummary");
  const fpDetail = document.getElementById("fpDetail");
  const pvDue = document.getElementById("pvDue");
  const pvOver = document.getElementById("pvOver");
  const notiUnread = document.getElementById("notiUnread");

  function fmtThai(iso){
    if(!iso) return "-";
    return new Date(iso).toLocaleDateString("th-TH",{dateStyle:"long"});
  }

  // 1) Family Planning summary (latest prediction)
  try{
    const pred = await api.fpPredLatest();
    const item = pred?.item || null;

    if(!item){
      fpSummary.textContent = t("home.fpNoData");
      fpDetail.textContent = "";
    } else {
      fpSummary.textContent = "‚úÖ " + t("home.fpCardTitle");
      fpDetail.innerHTML =
        `${t("home.fpNextPeriod")} <b>${fmtThai(item.nextPeriodExpectedDate)}</b><br/>` +
        `${t("home.fpOvulation")} <b>${fmtThai(item.ovulationDate)}</b><br/>` +
        `${t("home.fpFertile")} <b>${fmtThai(item.fertileStartDate)} ‚Äì ${fmtThai(item.fertileEndDate)}</b>`;
    }
  }catch{
    fpSummary.textContent = t("home.fpNoData");
    fpDetail.textContent = "";
  }

  // 2) Preventive counts
  try{
    const pv = await api.preventiveList();
    pvDue.textContent = pv?.counts?.dueToday ?? "-";
    pvOver.textContent = pv?.counts?.overdue ?? "-";
  }catch{
    pvDue.textContent = "-";
    pvOver.textContent = "-";
  }

  // 3) Notifications unread
  try{
    const u = await api.userNotificationsUnreadCount();
    notiUnread.textContent = (u?.unread ?? 0);
  }catch{
    notiUnread.textContent = "-";
  }
</script>

<style>
  .container{max-width:900px;margin:0 auto;padding:18px}
  .muted{opacity:.7}
  .card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:16px}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  .subcard{border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:12px;background:#fff}
  .k{font-weight:900;margin-bottom:6px}
  .row{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
  .tile{
    display:flex;align-items:center;justify-content:center;
    padding:14px;border-radius:14px;
    border:1px solid rgba(0,0,0,.10);
    text-decoration:none;color:#111;background:#fff;font-weight:900;
    min-height:60px;text-align:center;
  }
  .link{display:inline-block;margin-top:10px;text-decoration:none;font-weight:900}
</style>
</body>
</html>