<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FEMI • Preventive</title>
  <link rel="stylesheet" href="../assets/app.css" />
</head>
<body>
  <div id="app">
    <main class="container">
      <h1 class="page-title">Preventive Lifestyle</h1>
      <p class="page-sub muted">รายการดูแลสุขภาพเชิงป้องกันของคุณ</p>

      <section class="stat-row">
        <div class="card stat">
          <div class="k">งานทั้งหมด</div>
          <div class="v" id="statTotal">-</div>
        </div>
        <div class="card stat">
          <div class="k">ครบกำหนดวันนี้</div>
          <div class="v" id="statToday">-</div>
        </div>
        <div class="card stat">
          <div class="k">เลยกำหนด</div>
          <div class="v" id="statOverdue">-</div>
        </div>
      </section>

      <div class="tabs">
        <button class="tab active" data-tab="today">วันนี้</button>
        <button class="tab" data-tab="upcoming">กำลังจะถึง</button>
        <button class="tab" data-tab="all">ทั้งหมด</button>
      </div>

      <div id="loading" class="muted">กำลังโหลด…</div>
      <div id="empty" class="card hidden" style="padding:14px">ยังไม่มีรายการ</div>
      <div id="list" style="display:flex;flex-direction:column;gap:10px"></div>
    </main>
  </div>

  <script type="module">
    import { initUserShell } from "../js/shell.js";
    import { api } from "../js/api.js";

    await initUserShell({ active: "tools", title: "Preventive" });

    const elList = document.getElementById('list');
    const elEmpty = document.getElementById('empty');
    const elLoading = document.getElementById('loading');

    const statTotal = document.getElementById('statTotal');
    const statToday = document.getElementById('statToday');
    const statOverdue = document.getElementById('statOverdue');

    const tabs = Array.from(document.querySelectorAll('.tab'));
    let currentTab = 'today';
    let cache = [];

    function fmt(dt){
      if(!dt) return '-';
      const d = new Date(dt);
      return d.toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' });
    }

    function esc(s){
      return String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    function render(){
      const items = cache.filter(it => {
        if (currentTab === 'today') return it.isDueToday || it.isOverdue;
        if (currentTab === 'upcoming') return !it.isDueToday && !it.isOverdue;
        return true;
      });

      elList.innerHTML = '';
      elEmpty.classList.toggle('hidden', items.length !== 0);

      items.forEach(it => {
        const card = document.createElement('div');
        card.className = 'card item-card';
        const pill = it.isOverdue ? `<span class="pill over">เลยกำหนด</span>` : it.isDueToday ? `<span class="pill due">วันนี้</span>` : `<span class="pill">${esc(it.category||'ทั่วไป')}</span>`;

        card.innerHTML = `
          <div class="item-top">
            <div>
              <div class="item-title">${esc(it.title)}</div>
              <div class="muted" style="margin-top:4px">ครบกำหนด: ${fmt(it.nextDueAt)}</div>
            </div>
            ${pill}
          </div>
          ${it.description ? `<div class="muted">${esc(it.description)}</div>` : ''}
          <div class="actions">
            <button class="btn btn-ok" data-act="done">ทำแล้ว</button>
            <button class="btn btn-warn" data-act="skip">ข้าม</button>
          </div>
        `;

        card.querySelector('[data-act="done"]').addEventListener('click', async () => {
          await actDone(it.userItemId);
        });
        card.querySelector('[data-act="skip"]').addEventListener('click', async () => {
          const reason = prompt('เหตุผลที่ข้าม (ไม่บังคับ)') || '';
          await actSkip(it.userItemId, reason);
        });

        elList.appendChild(card);
      });
    }

    async function load(){
      elLoading.classList.remove('hidden');
      try {
        const res = await api.preventiveList();
        cache = res.items || [];
        statTotal.textContent = res.counts?.total ?? cache.length;
        statToday.textContent = res.counts?.dueToday ?? 0;
        statOverdue.textContent = res.counts?.overdue ?? 0;
        render();
      } catch(e){
        console.error(e);
        alert(e?.error?.message || 'โหลดข้อมูลไม่สำเร็จ');
      } finally {
        elLoading.classList.add('hidden');
      }
    }

    async function actDone(userItemId){
      try {
        await api.preventiveMarkDone(userItemId);
        await load();
      } catch(e){
        console.error(e);
        alert(e?.error?.message || 'ทำรายการไม่สำเร็จ');
      }
    }

    async function actSkip(userItemId, reason){
      try {
        await api.preventiveMarkSkipped(userItemId, reason);
        await load();
      } catch(e){
        console.error(e);
        alert(e?.error?.message || 'ข้ามรายการไม่สำเร็จ');
      }
    }

    tabs.forEach(btn => btn.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      currentTab = btn.dataset.tab;
      render();
    }));

    await load();
  </script>
</body>
</html>
