<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FEMI • การแจ้งเตือน</title>
  <link rel="stylesheet" href="../assets/app.css" />
</head>
<body>
  <div id="app">
    <main class="container">
      <h1 class="page-title">การแจ้งเตือน</h1>
      <p class="page-sub muted">ข้อความแจ้งเตือนภายในแอป</p>

      <div id="loading" class="muted">กำลังโหลด…</div>
      <div id="empty" class="card hidden" style="padding:14px">ยังไม่มีการแจ้งเตือน</div>
      <div id="list" style="display:flex;flex-direction:column;gap:10px"></div>
    </main>
  </div>

  <script type="module">
    import { initUserShell } from "../js/shell.js";
    import { api } from "../js/api.js";

    await initUserShell({ active: "tools", title: "การแจ้งเตือน" });

    const elLoading = document.getElementById('loading');
    const elEmpty = document.getElementById('empty');
    const elList = document.getElementById('list');

    function esc(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;');
    }

    function normalizeItems(res){
      // รองรับทุกแบบ: array / {items:[...]} / {data:{items:[...]}} / null/undefined
      if (Array.isArray(res)) return res;
      if (Array.isArray(res?.items)) return res.items;
      if (Array.isArray(res?.data?.items)) return res.data.items;
      return [];
    }

    async function load(){
      elLoading.classList.remove('hidden');
      elEmpty.classList.add('hidden');
      elList.innerHTML = '';
      try {
        const res = await api.userNotificationsList(50);
        const items = normalizeItems(res);

        if ((items?.length ?? 0) === 0) {
          elEmpty.classList.remove('hidden');
          return;
        }

        items.forEach(n => {
          const created = n.createdAt || n.publishedAt || n.scheduleAt || "";
          const card = document.createElement('div');
          card.className = 'card';
          card.style.padding = '14px';

          const id = n.notificationId || n.id || "";
          const isRead = Boolean(n.isRead);

          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
              <div>
                <div style="font-weight:900">${esc(n.title || 'แจ้งเตือน')}</div>
                <div class="muted" style="margin-top:4px">${esc(n.message || n.summary || '')}</div>
                <div class="muted" style="font-size:12px;margin-top:8px">
                  ${created ? new Date(created).toLocaleString('th-TH',{dateStyle:'medium',timeStyle:'short'}) : ''}
                </div>
              </div>
              ${isRead
                ? `<span class="pill">อ่านแล้ว</span>`
                : (id ? `<button class="btn btn-ghost" data-id="${esc(id)}">ทำเครื่องหมายว่าอ่านแล้ว</button>` : ``)
              }
            </div>
          `;

          const btn = card.querySelector('button');
          if (btn){
            btn.addEventListener('click', async () => {
              try {
                await api.userNotificationsMarkRead(btn.dataset.id);
                await load();
              } catch(e){
                console.error(e);
                alert(e?.error?.message || 'ทำรายการไม่สำเร็จ');
              }
            });
          }

          elList.appendChild(card);
        });

      } catch(e){
        console.error(e);
        alert(e?.error?.message || 'โหลดการแจ้งเตือนไม่สำเร็จ');
      } finally {
        elLoading.classList.add('hidden');
      }
    }

    await load();
  </script>
</body>
</html>