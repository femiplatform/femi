<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FEMI • Dashboard</title>
  <link rel="stylesheet" href="../assets/app.css"/>
</head>
<body>
<div id="app">
  <main class="container">
    <h1 data-i18n="page.dashboard">แดชบอร์ด</h1>
    <p class="muted" data-i18n="dash.subtitle">สรุปภาพรวมการใช้งานและผลลัพธ์ของคุณ</p>

    <div class="card" style="padding:14px;margin-top:10px">
      <div style="font-weight:900" data-i18n="dash.fpTitle">วางแผนครอบครัว</div>
      <div class="grid2" style="margin-top:10px">
        <div class="stat">
          <div class="muted" data-i18n="dash.fpCycles">จำนวนรอบเดือนที่บันทึก</div>
          <div class="value" id="fpCycles">-</div>
        </div>
        <div class="stat">
          <div class="muted" data-i18n="dash.fpLogsMonth">บันทึกรายวันเดือนนี้</div>
          <div class="value" id="fpLogs">-</div>
        </div>
      </div>
    </div>

    <!-- FP prediction summary -->
    <div class="card" style="padding:14px;margin-top:12px">
      <div style="font-weight:900" data-i18n="dash.fpPredTitle">คาดการณ์ล่าสุด</div>
      <div class="muted" id="fpPredText" style="margin-top:6px">-</div>
      <div id="fpPredDetail" class="pred-detail"></div>
    </div>

    <!-- 7-day streak -->
    <div class="card" style="padding:14px;margin-top:12px">
      <div style="font-weight:900" data-i18n="dash.streakTitle">ความสม่ำเสมอการบันทึก</div>
      <div class="row">
        <span class="muted" data-i18n="dash.streak7">7 วันล่าสุด บันทึกแล้ว</span>
        <b id="streak7">-</b>
      </div>
    </div>

    <div class="card" style="padding:14px;margin-top:12px">
      <div style="font-weight:900" data-i18n="dash.pvTitle">Preventive</div>
      <div class="grid2" style="margin-top:10px">
        <div class="stat">
          <div class="muted" data-i18n="dash.pvDueToday">ครบกำหนดวันนี้</div>
          <div class="value" id="pvDue">-</div>
        </div>
        <div class="stat">
          <div class="muted" data-i18n="dash.pvOverdue">เลยกำหนด</div>
          <div class="value" id="pvOver">-</div>
        </div>
      </div>
    </div>

    <div class="card" style="padding:14px;margin-top:12px">
      <div style="font-weight:900" data-i18n="dash.quizTitle">แบบทดสอบ</div>
      <div class="grid2" style="margin-top:10px">
        <div class="stat">
          <div class="muted" data-i18n="dash.quizLastScore">คะแนนล่าสุด</div>
          <div class="value" id="quizLast">-</div>
          <div class="muted" id="quizHint" style="font-size:12px"></div>
        </div>
      </div>
    </div>
  </main>
</div>

<script type="module">
  import { initUserShell } from "../js/shell.js";
  import { api } from "../js/api.js";
  import { t, applyI18n } from "../js/i18n.js";

  await initUserShell({ active: "dashboard", title: t("page.dashboard") });
  applyI18n(document);

  const fpCycles = document.getElementById("fpCycles");
  const fpLogs = document.getElementById("fpLogs");
  const pvDue = document.getElementById("pvDue");
  const pvOver = document.getElementById("pvOver");
  const quizLast = document.getElementById("quizLast");
  const quizHint = document.getElementById("quizHint");
  const fpPredText = document.getElementById("fpPredText");
  const fpPredDetail = document.getElementById("fpPredDetail");
  const streak7 = document.getElementById("streak7");

  function iso(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function fmtThai(isoStr){
    if(!isoStr) return "-";
    return new Date(isoStr).toLocaleDateString("th-TH",{dateStyle:"long"});
  }

  // FP summary (อ่านจากข้อมูลที่บันทึกในเครื่องผู้ใช้)
  const FP_LS_KEY = "FEMI_FAMILY_PLANNING_LOCAL_V2"; // ต้องตรงกับหน้า family_planning.html เวอร์ชันใหม่

  const pad2 = (n)=>String(n).padStart(2,"0");
  const iso = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const addDays = (isoStr, days)=>{
    const d = new Date(isoStr + "T00:00:00");
    d.setDate(d.getDate()+days);
    return iso(d);
  };
  const readFpLocal = ()=>{
    try{
      const raw = localStorage.getItem(FP_LS_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  };
  const fpCompute = (st)=>{
    const cycles = Array.isArray(st?.cycles) ? st.cycles : [];
    if(!cycles.length) return null;
    const latest = cycles.slice().sort((a,b)=>String(b.start||"").localeCompare(String(a.start||"")))[0];
    const start = latest.start;
    const cycleLen = Number(latest.cycleLen||latest.cycleLengthDays||st?.settings?.cycleLen||28) || 28;
    const periodLen = Number(latest.periodLen||latest.periodLengthDays||st?.settings?.periodLen||5) || 5;
    const nextStart = addDays(start, Math.round(cycleLen));
    const ovulation = addDays(nextStart, -14);
    const fertileStart = addDays(ovulation, -5);
    const fertileEnd = ovulation;
    return { start, cycleLen, periodLen, nextStart, ovulation, fertileStart, fertileEnd };
  };
  const countLogsInRange = (logs, fromIso, toIso)=>{
    if(!logs) return 0;
    const keys = Object.keys(logs);
    return keys.filter(k => k >= fromIso && k <= toIso).length;
  };

  try{
    const st = readFpLocal();
    const cycles = Array.isArray(st?.cycles) ? st.cycles : [];
    fpCycles.textContent = cycles.length;

    // logs this month
    const now = new Date();
    const from = iso(new Date(now.getFullYear(), now.getMonth(), 1));
    const to = iso(new Date(now.getFullYear(), now.getMonth()+1, 0));
    fpLogs.textContent = countLogsInRange(st?.logs, from, to);

    // latest prediction
    const p = st ? fpCompute(st) : null;
    if(!p){
      fpPredText.textContent = t("dash.fpNoPred");
      fpPredDetail.innerHTML = "";
    } else {
      fpPredText.textContent = "✅ " + t("dash.fpPredTitle");
      fpPredDetail.innerHTML =
        `<div class="pred-line">${t("dash.fpNextPeriod")} <b>${fmtThai(p.nextStart)}</b></div>` +
        `<div class="pred-line">${t("dash.fpOvulation")} <b>${fmtThai(p.ovulation)}</b></div>` +
        `<div class="pred-line">${t("dash.fpFertile")} <b>${fmtThai(p.fertileStart)} – ${fmtThai(p.fertileEnd)}</b></div>`;
    }

    // 7-day streak (distinct logDate in last 7 days)
    const to7 = iso(now);
    const from7 = iso(new Date(now.getFullYear(), now.getMonth(), now.getDate() - 6));
    const n7 = countLogsInRange(st?.logs, from7, to7);
    streak7.textContent = t("dash.days", { n: n7 });
  }catch{
    fpCycles.textContent = "-";
    fpLogs.textContent = "-";
    fpPredText.textContent = t("dash.fpNoPred");
    fpPredDetail.innerHTML = "";
    streak7.textContent = "-";
  }

  // Preventive counts
  try{
    const pv = await api.preventiveList();
    pvDue.textContent = pv?.counts?.dueToday ?? "-";
    pvOver.textContent = pv?.counts?.overdue ?? "-";
  }catch{
    pvDue.textContent = "-";
    pvOver.textContent = "-";
  }

  // Quiz last score
  try{
    const res = await api.quizMyResults();
    const arr = Array.isArray(res) ? res : (Array.isArray(res?.items) ? res.items : []);
    const last = arr[0] || null;
    quizLast.textContent = last ? `${last.score}/${last.total}` : "-";
    quizHint.textContent = last
      ? (last.takenAt ? new Date(last.takenAt).toLocaleString("th-TH",{dateStyle:"medium",timeStyle:"short"}) : "")
      : t("dash.quizNoData");
  }catch{
    quizLast.textContent = "-";
    quizHint.textContent = t("dash.quizNoData");
  }
</script>

<style>
  .container{max-width:900px;margin:0 auto;padding:18px}
  .muted{opacity:.7}
  .card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:16px}
  .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .stat{border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:12px}
  .value{font-size:28px;font-weight:900;margin-top:6px}
  .pred-detail{margin-top:10px;display:flex;flex-direction:column;gap:6px}
  .pred-line{font-size:13px;opacity:.9}
  .row{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
  @media (max-width:700px){.grid2{grid-template-columns:1fr}}
</style>
</body>
</html>