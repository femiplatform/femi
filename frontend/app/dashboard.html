<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FEMI ‚Ä¢ Dashboard</title>
  <link rel="stylesheet" href="../assets/app.css"/>
  <style>
    .container{max-width:980px;margin:0 auto;padding:18px}
    .muted{opacity:.75}
    .card{background:#fff;border:1px solid rgba(2,6,23,.08);border-radius:18px}
    .hero{
      padding:14px;
      background: radial-gradient(1200px 600px at 10% 0%, rgba(186,230,253,.55), transparent 55%),
                  radial-gradient(900px 500px at 90% 15%, rgba(253,230,138,.35), transparent 55%),
                  radial-gradient(900px 520px at 35% 95%, rgba(221,214,254,.42), transparent 60%),
                  rgba(255,255,255,.86);
      box-shadow: 0 18px 60px rgba(0,0,0,.08);
      backdrop-filter: blur(10px);
    }
    .heroTop{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .hello{font-weight:1000;font-size:22px;letter-spacing:-.2px}
    .sub{font-size:12px;line-height:1.6}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(2,6,23,.10);
      background: rgba(255,255,255,.72);
      font-weight:900;font-size:12px;
      white-space:nowrap;
    }
    .ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:0;border-radius:14px;padding:10px 12px;font-weight:1000;cursor:pointer}
    .btn-primary{background:#b91c1c;color:#fff}
    .btn-ghost{background:rgba(255,255,255,.8);border:1px solid rgba(2,6,23,.10);color:#0f172a}

    .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:12px}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:12px}
    @media (max-width:900px){.grid3{grid-template-columns:1fr}.grid2{grid-template-columns:1fr}}

    .kpi{
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(2,6,23,.08);
      background: rgba(255,255,255,.82);
      box-shadow: 0 12px 32px rgba(0,0,0,.06);
      position:relative;
      overflow:hidden;
    }
    .kpi:before{
      content:"";
      position:absolute;inset:-40px -40px auto auto;
      width:140px;height:140px;border-radius:999px;
      filter: blur(0px);
      opacity:.55;
      background: radial-gradient(circle at 30% 30%, rgba(14,165,233,.35), rgba(59,130,246,.0) 65%);
    }
    .kpiTitle{font-weight:900;font-size:12px;opacity:.75}
    .kpiVal{font-weight:1100;font-size:32px;line-height:1.05;margin-top:6px}
    .kpiHint{font-size:12px;opacity:.8;margin-top:6px;line-height:1.6}
    .kpiVal b{color:#0369a1}

    .panelHead{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .panelTitle{font-weight:1000}
    .mini{font-size:12px;opacity:.75}

    /* Charts */
    .chartBox{padding:14px}
    canvas{max-width:100%}

    /* Mini calendar */
    .cal{padding:14px}
    .calTop{display:flex;align-items:center;justify-content:space-between}
    .calTitle{font-weight:1000}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
    .dow{font-size:11px;font-weight:1000;opacity:.55;text-align:center}
    .day{
      border:1px solid rgba(2,6,23,.08);
      border-radius:14px;
      padding:9px 8px;
      min-height:52px;
      background: rgba(255,255,255,.82);
      cursor:pointer;
    }
    .day.muted{opacity:.45}
    .n{font-weight:1000}
    .dots{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
    .dot{width:8px;height:8px;border-radius:999px}
    .dot.period{background:#ef4444}
    .dot.fertile{background:#f59e0b}
    .dot.ovu{background:#8b5cf6}
    .dot.next{background:#22c55e}
    .dot.log{background:#0ea5e9}

    /* Knowledge + Quiz */
    .item{padding:14px}
    .linkCard{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid rgba(2,6,23,.08);
      border-radius:18px;
      padding:12px 12px;
      background: rgba(255,255,255,.82);
      cursor:pointer;
      text-decoration:none;
      color:inherit;
    }
    .linkCard:hover{box-shadow:0 16px 44px rgba(0,0,0,.08)}
    .linkTitle{font-weight:1000}
    .linkSub{font-size:12px;opacity:.75;margin-top:4px;line-height:1.5}

    /* Modal (reuse simple) */
    .modal{position:fixed;inset:0;z-index:80;display:flex;align-items:flex-end;justify-content:center}
    .modal.hidden{display:none}
    .modalCard{width:min(560px,96vw);background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.18);margin:12px;overflow:hidden}
    .modalHead{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(0,0,0,.06)}
    .modalTitle{font-weight:1000}
    .xbtn{border:1px solid rgba(0,0,0,.10);background:#fff;border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:900}
    .modalBody{padding:14px;display:flex;flex-direction:column;gap:10px}
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:-1}
    .row2{display:flex;gap:12px;flex-wrap:wrap}
    .row2 > *{flex:1 1 200px}
  </style>
</head>
<body>
<div id="app">
  <main class="container">
    <!-- Page header inside content -->
    <div class="card hero">
      <div class="heroTop">
        <div>
          <div class="hello" id="hello">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ üëã</div>
          <div class="sub muted" id="todayText">‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÜ</div>
        </div>
        <div class="pill" id="todayPill">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      </div>

      <div class="ctaRow">
        <button class="btn btn-primary" id="btnGo">‡πÑ‡∏õ‡∏ó‡∏≥‡πÄ‡∏•‡∏¢</button>
        <a class="btn btn-ghost" href="./tools.html" style="text-decoration:none;display:inline-flex;align-items:center">‡∏î‡∏π‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
      </div>

      <div class="grid3" style="margin-top:14px">
        <div class="kpi" id="kpiFp">
          <div class="kpiTitle">‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
          <div class="kpiVal" id="kpiNext">-</div>
          <div class="kpiHint" id="kpiFpHint">-</div>
        </div>
        <div class="kpi" id="kpiPv">
          <div class="kpiTitle">‡∏á‡∏≤‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á</div>
          <div class="kpiVal"><span id="kpiOver">-</span></div>
          <div class="kpiHint" id="kpiPvHint">-</div>
        </div>
        <div class="kpi" id="kpiQuiz">
          <div class="kpiTitle">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <div class="kpiVal" id="kpiQuizVal">-</div>
          <div class="kpiHint" id="kpiQuizHint">-</div>
        </div>
      </div>
    </div>

    <div class="grid2">
      <!-- Mini calendar -->
      <div class="card cal">
        <div class="calTop">
          <div>
            <div class="panelTitle">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (‡∏¢‡πà‡∏≠)</div>
            <div class="mini muted">‡πÅ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
          </div>
          <a class="btn btn-ghost" href="./family_planning.html" style="text-decoration:none">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</a>
        </div>

        <div class="calTop" style="margin-top:10px">
          <button class="btn btn-ghost" id="calPrev" aria-label="prev">‚Äπ</button>
          <div class="calTitle" id="calTitle">-</div>
          <button class="btn btn-ghost" id="calNext" aria-label="next">‚Ä∫</button>
        </div>

        <div class="calGrid" id="calGrid"></div>

        <div class="mini muted" style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          <span style="display:inline-flex;align-items:center;gap:6px"><span class="dot period"></span>‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
          <span style="display:inline-flex;align-items:center;gap:6px"><span class="dot fertile"></span>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</span>
          <span style="display:inline-flex;align-items:center;gap:6px"><span class="dot ovu"></span>‡πÑ‡∏Ç‡πà‡∏ï‡∏Å</span>
          <span style="display:inline-flex;align-items:center;gap:6px"><span class="dot next"></span>‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
          <span style="display:inline-flex;align-items:center;gap:6px"><span class="dot log"></span>‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
        </div>
      </div>

      <!-- Charts -->
      <div class="card chartBox">
        <div class="panelHead">
          <div>
            <div class="panelTitle">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏≤‡∏ü</div>
            <div class="mini muted">‡∏î‡∏π‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="mini muted" style="font-weight:900">‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å 14 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <canvas id="chartLogs" height="140"></canvas>
        </div>

        <div style="margin-top:12px">
          <div class="mini muted" style="font-weight:900">Preventive: ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î/‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>
          <canvas id="chartPv" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="grid2">
      <div class="card item">
        <div class="panelHead">
          <div>
            <div class="panelTitle">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            <div class="mini muted" id="kbHint">‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á</div>
          </div>
          <a class="btn btn-ghost" href="./knowledge.html" style="text-decoration:none">‡πÑ‡∏õ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</a>
        </div>
        <div style="margin-top:10px" class="linkCard" id="kbCard" role="button" tabindex="0">
          <div>
            <div class="linkTitle" id="kbTitle">-</div>
            <div class="linkSub" id="kbSub">-</div>
          </div>
          <div class="pill">‡∏≠‡πà‡∏≤‡∏ô</div>
        </div>
      </div>

      <div class="card item">
        <div class="panelHead">
          <div>
            <div class="panelTitle">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô)</div>
            <div class="mini muted">‡∏Å‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</div>
          </div>
        </div>

        <div class="row2" style="margin-top:10px">
          <button class="btn btn-ghost" id="chkWater">‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥</button>
          <button class="btn btn-ghost" id="chkMove">‡∏Ç‡∏¢‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</button>
          <button class="btn btn-ghost" id="chkSleep">‡∏ô‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏≠</button>
        </div>
        <div class="mini muted" id="chkHint" style="margin-top:10px">-</div>
      </div>
    </div>
  </main>

  <!-- Daily log modal (quick) -->
  <div class="modal hidden" id="logModal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="modalTitle">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
        <button class="xbtn" id="logClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="mini muted" id="logDateLabel">-</div>
        <div class="row2">
          <div>
            <div class="mini muted" style="font-weight:900">‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å</div>
            <select id="bleeding">
              <option value="None">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
              <option value="Spotting">‡∏Å‡∏∞‡∏õ‡∏£‡∏¥‡∏ö‡∏Å‡∏∞‡∏õ‡∏£‡∏≠‡∏¢</option>
              <option value="Light">‡∏ô‡πâ‡∏≠‡∏¢</option>
              <option value="Medium">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
              <option value="Heavy">‡∏°‡∏≤‡∏Å</option>
            </select>
          </div>
          <div>
            <div class="mini muted" style="font-weight:900">‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå</div>
            <select id="mood">
              <option value="Good">‡∏î‡∏µ</option>
              <option value="Neutral">‡∏õ‡∏Å‡∏ï‡∏¥</option>
              <option value="Bad">‡πÅ‡∏¢‡πà</option>
            </select>
          </div>
        </div>
        <div>
          <div class="mini muted" style="font-weight:900">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</div>
          <textarea id="symptoms" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á ‡∏õ‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏á ‡∏ï‡∏Å‡∏Ç‡∏≤‡∏ß ‡∏™‡∏¥‡∏ß ‡∏Ø‡∏•‡∏Ø"></textarea>
        </div>
        <div class="row2">
          <label style="display:flex;align-items:center;gap:8px;font-weight:900"><input type="checkbox" id="hadSex"> ‡∏°‡∏µ‡πÄ‡∏û‡∏®‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</label>
          <label style="display:flex;align-items:center;gap:8px;font-weight:900"><input type="checkbox" id="pillTaken"> ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏Ñ‡∏∏‡∏°</label>
        </div>
        <div>
          <div class="mini muted" style="font-weight:900">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
          <textarea id="notes" rows="2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
        </div>
        <button class="btn btn-primary" id="logSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
    <div class="backdrop" id="logBackdrop"></div>
  </div>
</div>

<script type="module">
  import { initUserShell } from "../js/shell.js";
  import { api } from "../js/api.js";
  import { t, applyI18n } from "../js/i18n.js";

  await initUserShell({ active: "dashboard", title: t("page.dashboard") });
  try{ applyI18n(document); }catch{}

  // ---------------- Helpers ----------------
  const el = (id)=>document.getElementById(id);
  const pad2 = (n)=>String(n).padStart(2,"0");
  const iso = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const addDays = (isoStr, days)=>{
    const d = new Date(isoStr + "T00:00:00");
    d.setDate(d.getDate()+days);
    return iso(d);
  };
  const fmtThai = (isoStr)=>{
    try{
      if(!isoStr) return "-";
      return new Date(isoStr + "T00:00:00").toLocaleDateString("th-TH", { year:"numeric", month:"long", day:"numeric" });
    }catch{ return "-"; }
  };
  const safeJson = (v)=>{ try{ return JSON.parse(v); }catch{ return null; } };

  function findName(){
    // Try common patterns in localStorage without breaking
    const candidates = ["FEMI_USER", "FEMI_PROFILE", "FEMI_USER_PROFILE", "userProfile", "profile"];
    for(const k of candidates){
      const obj = safeJson(localStorage.getItem(k));
      if(obj){
        const name = obj.fullName || obj.name || obj.displayName || [obj.firstName, obj.lastName].filter(Boolean).join(" ");
        if(name) return name;
      }
    }
    return "";
  }

  const today = new Date();
  el("todayPill").textContent = "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Ä¢ " + today.toLocaleDateString("th-TH", { weekday:"short", day:"numeric", month:"short" });
  const nm = findName();
  el("hello").textContent = nm ? `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ üëã ${nm}` : "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ üëã";

  // ---------------- Family Planning from localStorage ----------------
  const FP_LS_KEY = "FEMI_FAMILY_PLANNING_LOCAL_V2";
  const readFp = ()=>{
    try{
      const raw = localStorage.getItem(FP_LS_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  };

  const fpCompute = (st, cycleStartOverride=null)=>{
    const cycles = Array.isArray(st?.cycles) ? st.cycles : [];
    if(!cycles.length) return null;

    const chosen = cycleStartOverride
      ? cycles.find(c=>c.start===cycleStartOverride) || null
      : null;

    const latest = chosen || cycles.slice().sort((a,b)=>String(b.start||"").localeCompare(String(a.start||"")))[0];

    const start = latest.start;
    const cycleLen = Number(latest.cycleLen || latest.cycleLengthDays || st?.settings?.cycleLen || 28) || 28;
    const periodLen = Number(latest.periodLen || latest.periodLengthDays || st?.settings?.periodLen || 5) || 5;

    const nextStart = addDays(start, Math.round(cycleLen));
    const ovulation = addDays(nextStart, -14);
    const fertileStart = addDays(ovulation, -5);
    const fertileEnd = ovulation;
    const periodStart = start;
    const periodEnd = addDays(start, Math.max(0, Math.round(periodLen)-1));

    return { start, cycleLen, periodLen, nextStart, ovulation, fertileStart, fertileEnd, periodStart, periodEnd };
  };

  const countLogsInRange = (logs, fromIso, toIso)=>{
    if(!logs) return 0;
    return Object.keys(logs).filter(k => k >= fromIso && k <= toIso).length;
  };

  const fpState = readFp();
  const fpPred = fpState ? fpCompute(fpState) : null;

  // KPI: next period + CTA suggestion
  let primaryAction = { label:"‡πÑ‡∏õ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠", href:"./tools.html" };

  if(!fpPred){
    el("kpiNext").textContent = "-";
    el("kpiFpHint").textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå";
    primaryAction = { label:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", href:"./family_planning.html" };
  }else{
    el("kpiNext").innerHTML = `<b>${fmtThai(fpPred.nextStart)}</b>`;
    const inFertile = iso(today) >= fpPred.fertileStart && iso(today) <= fpPred.fertileEnd;
    el("kpiFpHint").textContent = inFertile
      ? `‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡πâ‡∏≠‡∏á ‚Ä¢ ${fmtThai(fpPred.fertileStart)} ‚Äì ${fmtThai(fpPred.fertileEnd)}`
      : `‡∏ß‡∏±‡∏ô‡πÑ‡∏Ç‡πà‡∏ï‡∏Å‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${fmtThai(fpPred.ovulation)}`;

    primaryAction = inFertile
      ? { label:"‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î", href:"./contraception_smart.html" }
      : { label:"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏≠‡∏≤‡∏Å‡∏≤‡∏£", href:"./family_planning.html" };
  }

  // 14-day log chart data
  const last14 = [];
  for(let i=13;i>=0;i--){
    const d = new Date(today.getFullYear(), today.getMonth(), today.getDate()-i);
    const k = iso(d);
    last14.push({ k, has: !!(fpState?.logs && fpState.logs[k]) });
  }

  // Mini calendar view
  let viewMonth = new Date(today.getFullYear(), today.getMonth(), 1);

  function renderCalendar(){
    const p = fpPred;
    const y=viewMonth.getFullYear(), m=viewMonth.getMonth();
    el("calTitle").textContent = viewMonth.toLocaleDateString("th-TH", { month:"long", year:"numeric" });

    const first = new Date(y,m,1);
    const startDow = first.getDay();
    const daysInMonth = new Date(y,m+1,0).getDate();
    const dows = ["‡∏≠‡∏≤","‡∏à","‡∏≠","‡∏û","‡∏û‡∏§","‡∏®","‡∏™"];
    let html = dows.map(x=>`<div class="dow">${x}</div>`).join("");

    for(let i=0;i<startDow;i++){
      html += `<div class="day muted"><div class="n"> </div></div>`;
    }

    for(let day=1; day<=daysInMonth; day++){
      const dateIso = iso(new Date(y,m,day));
      const dots = [];

      if(p){
        if(dateIso >= p.periodStart && dateIso <= p.periodEnd) dots.push("period");
        if(dateIso >= p.fertileStart && dateIso <= p.fertileEnd) dots.push("fertile");
        if(dateIso === p.ovulation) dots.push("ovu");
        if(dateIso === p.nextStart) dots.push("next");
      }
      if(fpState?.logs && fpState.logs[dateIso]) dots.push("log");

      html += `
        <div class="day" data-date="${dateIso}">
          <div class="n">${day}</div>
          <div class="dots">${dots.map(d=>`<span class="dot ${d}"></span>`).join("")}</div>
        </div>
      `;
    }

    el("calGrid").innerHTML = html;
    el("calGrid").querySelectorAll(".day[data-date]").forEach(cell=>{
      cell.addEventListener("click", ()=> openLog(cell.getAttribute("data-date")));
    });
  }

  el("calPrev").addEventListener("click", ()=>{
    viewMonth = new Date(viewMonth.getFullYear(), viewMonth.getMonth()-1, 1);
    renderCalendar();
  });
  el("calNext").addEventListener("click", ()=>{
    viewMonth = new Date(viewMonth.getFullYear(), viewMonth.getMonth()+1, 1);
    renderCalendar();
  });

  // Quick log modal (writes to FP localStorage to keep consistent)
  const logModal = el("logModal");
  const logDateLabel = el("logDateLabel");
  const bleeding = el("bleeding");
  const mood = el("mood");
  const symptoms = el("symptoms");
  const hadSex = el("hadSex");
  const pillTaken = el("pillTaken");
  const notes = el("notes");
  let currentLogDate = null;

  function openLog(dateIso){
    currentLogDate = dateIso;
    logDateLabel.textContent = fmtThai(dateIso);

    const log = fpState?.logs?.[dateIso] || null;
    bleeding.value = log?.bleeding || "None";
    mood.value = log?.mood || "Neutral";
    symptoms.value = log?.symptoms || "";
    hadSex.checked = !!log?.hadSex;
    pillTaken.checked = !!log?.pillTaken;
    notes.value = log?.notes || "";

    logModal.classList.remove("hidden");
  }
  function closeLog(){
    logModal.classList.add("hidden");
    currentLogDate = null;
  }
  el("logClose").addEventListener("click", closeLog);
  el("logBackdrop").addEventListener("click", closeLog);

  el("logSave").addEventListener("click", ()=>{
    if(!currentLogDate) return;

    const st = readFp() || { cycles: [], logs: {}, settings:{ cycleLen:28, periodLen:5 }, ui:{} };
    st.logs = st.logs || {};
    st.logs[currentLogDate] = {
      logDate: currentLogDate,
      bleeding: bleeding.value,
      mood: mood.value,
      symptoms: String(symptoms.value||"").trim(),
      hadSex: hadSex.checked,
      pillTaken: pillTaken.checked,
      notes: String(notes.value||"").trim(),
      updatedAt: new Date().toISOString()
    };
    localStorage.setItem(FP_LS_KEY, JSON.stringify(st));

    // keep fpState reference updated for this page
    Object.assign(fpState || {}, st);

    closeLog();
    renderCalendar();
    drawLogChart();
  });

  // ---------------- Preventive counts (API, guard) ----------------
  let pvDueToday = 0, pvOverdue = 0;
  try{
    if(api && typeof api.preventiveList === "function"){
      const pv = await api.preventiveList();
      pvDueToday = Number(pv?.counts?.dueToday ?? 0) || 0;
      pvOverdue  = Number(pv?.counts?.overdue ?? 0) || 0;
    }
  }catch{}

  el("kpiOver").textContent = pvOverdue ? String(pvOverdue) : "0";
  el("kpiPvHint").textContent = pvOverdue
    ? `‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${pvOverdue} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ${pvDueToday} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
    : `‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ${pvDueToday} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

  if(pvOverdue > 0){
    primaryAction = { label:"‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á", href:"./health_checklist.html" };
  }

  // ---------------- Quiz last score (API, guard) ----------------
  try{
    if(api && typeof api.quizMyResults === "function"){
      const res = await api.quizMyResults();
      const arr = Array.isArray(res) ? res : (Array.isArray(res?.items) ? res.items : []);
      const last = arr[0] || null;
      if(last){
        el("kpiQuizVal").textContent = `${last.score}/${last.total}`;
        el("kpiQuizHint").textContent = last.takenAt
          ? ("‡∏ó‡∏≥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + new Date(last.takenAt).toLocaleString("th-TH",{dateStyle:"medium",timeStyle:"short"}))
          : "‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î";
      }else{
        el("kpiQuizVal").textContent = "-";
        el("kpiQuizHint").textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô";
      }
    }else{
      el("kpiQuizVal").textContent = "-";
      el("kpiQuizHint").textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô";
    }
  }catch{
    el("kpiQuizVal").textContent = "-";
    el("kpiQuizHint").textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô";
  }

  // Set CTA
  const btnGo = el("btnGo");
  btnGo.textContent = primaryAction.label;
  btnGo.addEventListener("click", ()=> location.href = primaryAction.href);

  // ---------------- Knowledge today (local, lightweight) ----------------
  // Use knowledge local key if present; else fallback and point to knowledge page
  const kb = (()=>{
    try{
      const raw = localStorage.getItem("FEMI_KNOWLEDGE_V1");
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  })();

  const kbFallback = {
    title: "‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢",
    sub: "‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°",
    href: "./knowledge.html"
  };

  // If you use knowledge_v2.html (local items), it stores only featuredId; so show a friendly card.
  el("kbTitle").textContent = kbFallback.title;
  el("kbSub").textContent = kbFallback.sub;

  el("kbCard").addEventListener("click", ()=> location.href = kbFallback.href);
  el("kbCard").addEventListener("keydown", (e)=>{ if(e.key==="Enter") location.href = kbFallback.href; });

  // ---------------- Daily check-in (local) ----------------
  const CHECK_KEY = "FEMI_DASH_CHECKIN_V1";
  const checkState = (()=>{ try{ return JSON.parse(localStorage.getItem(CHECK_KEY) || "{}"); }catch{ return {}; } })();
  const todayKey = iso(today);
  if(!checkState[todayKey]) checkState[todayKey] = { water:false, move:false, sleep:false };

  function renderCheck(){
    const s = checkState[todayKey];
    const setBtn = (btn, on)=>{
      btn.style.background = on ? "rgba(34,197,94,.16)" : "rgba(255,255,255,.8)";
      btn.style.border = "1px solid rgba(2,6,23,.10)";
      btn.style.color = on ? "#166534" : "#0f172a";
      btn.textContent = btn.dataset.label + (on ? " ‚úì" : "");
    };
    setBtn(el("chkWater"), s.water);
    setBtn(el("chkMove"), s.move);
    setBtn(el("chkSleep"), s.sleep);

    const done = [s.water,s.move,s.sleep].filter(Boolean).length;
    el("chkHint").textContent = done===0 ? "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ" : `‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ${done}/3 ‡∏≠‡∏¢‡πà‡∏≤‡∏á`;
  }

  function toggleCheck(k){
    const s = checkState[todayKey];
    s[k] = !s[k];
    localStorage.setItem(CHECK_KEY, JSON.stringify(checkState));
    renderCheck();
  }

  el("chkWater").dataset.label = "‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥";
  el("chkMove").dataset.label = "‡∏Ç‡∏¢‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢";
  el("chkSleep").dataset.label = "‡∏ô‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏≠";
  el("chkWater").addEventListener("click", ()=>toggleCheck("water"));
  el("chkMove").addEventListener("click", ()=>toggleCheck("move"));
  el("chkSleep").addEventListener("click", ()=>toggleCheck("sleep"));
  renderCheck();

  // ---------------- Charts ----------------
  function drawLogChart(){
    const c = el("chartLogs");
    const ctx = c.getContext("2d");
    const w = c.width = c.clientWidth * devicePixelRatio;
    const h = c.height = 140 * devicePixelRatio;

    ctx.clearRect(0,0,w,h);

    // background
    ctx.fillStyle = "rgba(2,6,23,.04)";
    roundRect(ctx, 0,0,w,h, 16*devicePixelRatio); ctx.fill();

    const pad = 14*devicePixelRatio;
    const bw = (w - pad*2) / last14.length;
    const maxBar = h - pad*2 - 20*devicePixelRatio;

    // axis baseline
    ctx.strokeStyle = "rgba(2,6,23,.10)";
    ctx.lineWidth = 1*devicePixelRatio;
    ctx.beginPath();
    ctx.moveTo(pad, h-pad);
    ctx.lineTo(w-pad, h-pad);
    ctx.stroke();

    last14.forEach((d, i)=>{
      const x = pad + i*bw + bw*0.15;
      const barW = bw*0.7;
      const barH = d.has ? maxBar : maxBar*0.18;
      const y = h - pad - barH;

      const grad = ctx.createLinearGradient(0,y,0,y+barH);
      grad.addColorStop(0, d.has ? "rgba(14,165,233,.85)" : "rgba(148,163,184,.50)");
      grad.addColorStop(1, d.has ? "rgba(59,130,246,.55)" : "rgba(148,163,184,.25)");
      ctx.fillStyle = grad;
      roundRect(ctx, x, y, barW, barH, 10*devicePixelRatio);
      ctx.fill();

      // mark today
      if(d.k === iso(today)){
        ctx.fillStyle = "rgba(185,28,28,.85)";
        ctx.beginPath();
        ctx.arc(x+barW/2, h-pad+6*devicePixelRatio, 3.5*devicePixelRatio, 0, Math.PI*2);
        ctx.fill();
      }
    });

    // label
    ctx.fillStyle = "rgba(2,6,23,.75)";
    ctx.font = `${12*devicePixelRatio}px system-ui, -apple-system, Segoe UI, sans-serif`;
    ctx.fillText("‡∏ï‡πà‡∏≥", pad, 18*devicePixelRatio);
    ctx.fillText("‡∏™‡∏π‡∏á", pad, 34*devicePixelRatio);
  }

  function drawPvChart(){
    const c = el("chartPv");
    const ctx = c.getContext("2d");
    const w = c.width = c.clientWidth * devicePixelRatio;
    const h = c.height = 120 * devicePixelRatio;

    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = "rgba(2,6,23,.04)";
    roundRect(ctx, 0,0,w,h, 16*devicePixelRatio); ctx.fill();

    const pad = 14*devicePixelRatio;
    const total = Math.max(1, pvDueToday + pvOverdue);
    const duePct = pvDueToday / total;
    const overPct = pvOverdue / total;

    const cx = pad + 58*devicePixelRatio;
    const cy = h/2;
    const r  = 34*devicePixelRatio;
    const lw = 10*devicePixelRatio;

    // base ring
    ctx.lineWidth = lw;
    ctx.strokeStyle = "rgba(2,6,23,.10)";
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.stroke();

    // overdue (red)
    let start = -Math.PI/2;
    ctx.strokeStyle = "rgba(239,68,68,.90)";
    ctx.beginPath();
    ctx.arc(cx, cy, r, start, start + Math.PI*2*overPct);
    ctx.stroke();

    // due today (amber/blue)
    start = start + Math.PI*2*overPct;
    ctx.strokeStyle = "rgba(245,158,11,.90)";
    ctx.beginPath();
    ctx.arc(cx, cy, r, start, start + Math.PI*2*duePct);
    ctx.stroke();

    // text block
    ctx.fillStyle = "rgba(2,6,23,.90)";
    ctx.font = `${14*devicePixelRatio}px system-ui, -apple-system, Segoe UI, sans-serif`;
    ctx.fillText("‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î", cx + r + 18*devicePixelRatio, cy - 12*devicePixelRatio);
    ctx.fillStyle = "rgba(239,68,68,.92)";
    ctx.font = `${18*devicePixelRatio}px system-ui, -apple-system, Segoe UI, sans-serif`;
    ctx.fillText(String(pvOverdue), cx + r + 18*devicePixelRatio, cy + 10*devicePixelRatio);

    ctx.fillStyle = "rgba(2,6,23,.90)";
    ctx.font = `${14*devicePixelRatio}px system-ui, -apple-system, Segoe UI, sans-serif`;
    ctx.fillText("‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", cx + r + 110*devicePixelRatio, cy - 12*devicePixelRatio);
    ctx.fillStyle = "rgba(245,158,11,.92)";
    ctx.font = `${18*devicePixelRatio}px system-ui, -apple-system, Segoe UI, sans-serif`;
    ctx.fillText(String(pvDueToday), cx + r + 110*devicePixelRatio, cy + 10*devicePixelRatio);
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawAll(){
    drawLogChart();
    drawPvChart();
  }

  // initial render
  renderCalendar();
  drawAll();

  // redraw on resize
  let tmo = null;
  window.addEventListener("resize", ()=>{
    clearTimeout(tmo);
    tmo = setTimeout(drawAll, 120);
  });
</script>
</body>
</html>
