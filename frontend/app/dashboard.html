<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FEMI • แดชบอร์ด</title>
  <link rel="stylesheet" href="../assets/app.css" />
</head>
<body>
  <div id="app">
    <main class="container">
      <h1 class="page-title">แดชบอร์ด</h1>
      <p class="page-sub muted">สรุปการใช้งานและสถิติของคุณ</p>

      <section class="grid-3">
        <div class="card stat">
          <div class="k">Preventive วันนี้</div>
          <div class="v" id="dPrev">-</div>
          <div class="muted" id="dPrevHint">-</div>
        </div>
        <div class="card stat">
          <div class="k">คะแนนแบบทดสอบล่าสุด</div>
          <div class="v" id="dQuiz">-</div>
          <div class="muted" id="dQuizHint">-</div>
        </div>
        <div class="card stat">
          <div class="k">การแจ้งเตือนที่ยังไม่อ่าน</div>
          <div class="v" id="dNotif">-</div>
          <div class="muted">แตะไอคอนกระดิ่งเพื่อดูรายละเอียด</div>
        </div>
      </section>

      <section style="margin-top:14px">
        <div class="card" style="padding:14px">
          <div style="font-weight:800;margin-bottom:10px">สรุปล่าสุด</div>
          <div id="summary" class="muted">กำลังโหลด…</div>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    import { initUserShell } from "../js/shell.js";
    import { api } from "../js/api.js";

    await initUserShell({ active: "dashboard", title: "แดชบอร์ด" });

    const s = (id) => document.getElementById(id);

    // Preventive
    try {
      const p = await api.preventiveList();
      s('dPrev').textContent = p.counts?.dueToday ?? 0;
      s('dPrevHint').textContent = p.counts?.overdue ? `เลยกำหนด ${p.counts.overdue}` : 'พร้อมทำ';
    } catch(e){ console.error(e); }

    // Quiz
    try {
      const r = await api.quizMyResults();
      const last = Array.isArray(r) ? r[0] : null;
      s('dQuiz').textContent = last ? `${last.score}/${last.total}` : '-';
      s('dQuizHint').textContent = last ? (last.category ? `หมวด ${last.category}` : 'ผลล่าสุด') : 'ยังไม่มีผล';
    } catch(e){ console.error(e); }

    // Notifications
    try {
      const n = await api.userNotificationsUnreadCount();
      s('dNotif').textContent = n.unreadCount ?? 0;
    } catch(e){ s('dNotif').textContent = 0; }

    // Summary
    try {
      const me = await api.me();
      s('summary').textContent = `สวัสดี ${me.firstName||''} ${me.lastName||''}`.trim();
    } catch {
      s('summary').textContent = 'ยินดีต้อนรับ';
    }
  </script>
</body>
</html>
