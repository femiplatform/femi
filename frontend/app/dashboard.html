<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FEMI • Dashboard</title>
  <link rel="stylesheet" href="../assets/app.css"/>
  <style>
    :root{
      --ink: rgba(15,23,42,.92);
      --muted: rgba(15,23,42,.70);
      --border: rgba(2,6,23,.08);
      --shadow: 0 18px 60px rgba(2,6,23,.08);
      --shadow2: 0 12px 40px rgba(2,6,23,.06);

      --blueA: rgba(186,230,253,.55);
      --blueB: rgba(59,130,246,.12);

      --greenA: rgba(187,247,208,.55);
      --greenB: rgba(34,197,94,.12);

      --purpleA: rgba(233,213,255,.60);
      --purpleB: rgba(168,85,247,.12);

      --amberA: rgba(254,243,199,.55);
      --amberB: rgba(245,158,11,.12);
    }

    body{
      background:
        radial-gradient(900px 500px at 8% 0%, rgba(186,230,253,.55), transparent 55%),
        radial-gradient(820px 520px at 92% 6%, rgba(254,243,199,.45), transparent 55%),
        radial-gradient(900px 560px at 20% 95%, rgba(233,213,255,.45), transparent 60%),
        radial-gradient(820px 520px at 88% 92%, rgba(187,247,208,.45), transparent 60%),
        #fff;
    }

    .container{max-width:920px;margin:0 auto;padding:18px}
    .muted{opacity:1;color:var(--muted)}
    .card{
      background: rgba(255,255,255,.82);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }

    .hero{
      padding:16px 16px 14px;
      background:
        linear-gradient(135deg, rgba(255,255,255,.70), rgba(255,255,255,.60)),
        radial-gradient(900px 420px at 15% 0%, rgba(186,230,253,.55), transparent 55%),
        radial-gradient(700px 420px at 88% 20%, rgba(254,243,199,.45), transparent 60%);
      box-shadow: var(--shadow);
    }
    .hero h1{
      margin:0;
      font-size:22px;
      letter-spacing:-.2px;
      font-weight:1000;
      color:var(--ink);
    }
    .hero p{margin:6px 0 0;line-height:1.6}

    .sectionHead{
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .sectionTitle{
      font-weight:1000;
      color:var(--ink);
      display:flex;align-items:center;gap:10px;
    }
    .accentDot{
      width:12px;height:12px;border-radius:999px;display:inline-block;
      box-shadow: 0 10px 20px rgba(2,6,23,.12);
    }

    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width:760px){.grid2{grid-template-columns:1fr}.grid3{grid-template-columns:1fr}}

    .stat{
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      background: rgba(255,255,255,.86);
      box-shadow: 0 14px 40px rgba(2,6,23,.05);
      position:relative;
      overflow:hidden;
    }
    .stat:before{
      content:"";
      position:absolute; inset:-60px -60px auto auto;
      width:180px;height:180px;border-radius:999px;
      opacity:.6;
      background: radial-gradient(circle at 30% 30%, rgba(59,130,246,.22), rgba(59,130,246,0) 65%);
    }
    .stat.green:before{ background: radial-gradient(circle at 30% 30%, rgba(34,197,94,.22), rgba(34,197,94,0) 65%); }
    .stat.purple:before{ background: radial-gradient(circle at 30% 30%, rgba(168,85,247,.22), rgba(168,85,247,0) 65%); }

    .label{font-size:12px;font-weight:900;color:rgba(15,23,42,.68)}
    .value{
      font-size:34px;
      font-weight:1100;
      margin-top:6px;
      letter-spacing:-.4px;
      color:var(--ink);
      line-height:1.05;
    }
    .value small{font-size:16px;font-weight:1000;opacity:.75}
    .hint{margin-top:8px;font-size:12px;line-height:1.65;color:rgba(15,23,42,.72)}

    .pred-detail{margin-top:10px;display:flex;flex-direction:column;gap:6px}
    .pred-line{font-size:13px;line-height:1.6;color:rgba(15,23,42,.86)}
    .pred-line b{color:rgba(3,105,161,.95)}

    .row{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .badgePill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
      font-weight:1000;font-size:12px;color:rgba(15,23,42,.75);
    }

    .block{padding:14px;margin-top:12px}
    .block.blue{ background: linear-gradient(135deg, var(--blueA), rgba(255,255,255,.70)); }
    .block.green{ background: linear-gradient(135deg, var(--greenA), rgba(255,255,255,.70)); }
    .block.purple{ background: linear-gradient(135deg, var(--purpleA), rgba(255,255,255,.70)); }
  </style>
</head>
<body>
<div id="app">
  <main class="container">
    <div class="card hero">
      <h1>แดชบอร์ด</h1>
      <p class="muted">สรุปภาพรวมการใช้งานและผลลัพธ์ของคุณ</p>
    </div>

    <!-- 1) ผลการบันทึกรอบเดือน -->
    <div class="card block blue">
      <div class="sectionHead">
        <div class="sectionTitle"><span class="accentDot" style="background:rgba(59,130,246,.85)"></span>ผลการบันทึกรอบเดือน</div>
        <span class="badgePill">อ่านจากข้อมูลที่คุณบันทึก</span>
      </div>

      <div class="grid2">
        <div class="stat">
          <div class="label">จำนวนรอบเดือนที่บันทึก</div>
          <div class="value" id="fpCycles">-</div>
        </div>
        <div class="stat">
          <div class="label">บันทึกรายวันเดือนนี้</div>
          <div class="value" id="fpLogs">-</div>
        </div>
      </div>
    </div>

    <div class="card block blue">
      <div class="sectionHead">
        <div class="sectionTitle"><span class="accentDot" style="background:rgba(14,165,233,.90)"></span>คาดการณ์ (ล่าสุด)</div>
      </div>
      <div class="muted" id="fpPredText">-</div>
      <div id="fpPredDetail" class="pred-detail"></div>
    </div>

    <div class="card block blue">
      <div class="sectionHead">
        <div class="sectionTitle"><span class="accentDot" style="background:rgba(59,130,246,.65)"></span>ความสม่ำเสมอการบันทึก</div>
      </div>
      <div class="row">
        <span class="muted">7 วันล่าสุด บันทึกแล้ว</span>
        <span class="badgePill"><b id="streak7">-</b></span>
      </div>
    </div>

    <!-- 2) แผนตรวจสุขภาพ -->
    <div class="card block green">
      <div class="sectionHead">
        <div class="sectionTitle"><span class="accentDot" style="background:rgba(34,197,94,.85)"></span>แผนตรวจสุขภาพ</div>
        <span class="badgePill">อิงจาก “ตารางวางแผนตรวจสุขภาพทั้งปี”</span>
      </div>

      <div class="grid3">
        <div class="stat green">
          <div class="label">ทั้งหมด</div>
          <div class="value" id="hcAll">-</div>
        </div>
        <div class="stat green">
          <div class="label">ต้องทำ</div>
          <div class="value" id="hcDue">-</div>
        </div>
        <div class="stat green">
          <div class="label">ทำแล้ว</div>
          <div class="value" id="hcDone">-</div>
        </div>
      </div>
      <div class="hint" id="hcHint"></div>
    </div>

    <!-- 3) แบบทดสอบ -->
    <div class="card block purple">
      <div class="sectionHead">
        <div class="sectionTitle"><span class="accentDot" style="background:rgba(168,85,247,.85)"></span>แบบทดสอบความรู้สุขภาพ</div>
      </div>

      <div class="grid2">
        <div class="stat purple">
          <div class="label">คะแนนล่าสุด</div>
          <div class="value" id="quizLast">-</div>
          <div class="hint" id="quizHint"></div>
        </div>
      </div>
    </div>

  </main>
</div>

<script type="module">
  import { initUserShell } from "../js/shell.js";
  import { api } from "../js/api.js";
  import { t, applyI18n } from "../js/i18n.js";

  await initUserShell({ active: "dashboard", title: t("page.dashboard") });
  try{ applyI18n(document); }catch{}

  const fpCyclesEl = document.getElementById("fpCycles");
  const fpLogsEl = document.getElementById("fpLogs");
  const fpPredText = document.getElementById("fpPredText");
  const fpPredDetail = document.getElementById("fpPredDetail");
  const streak7 = document.getElementById("streak7");

  const hcAllEl = document.getElementById("hcAll");
  const hcDueEl = document.getElementById("hcDue");
  const hcDoneEl = document.getElementById("hcDone");
  const hcHintEl = document.getElementById("hcHint");

  const quizLast = document.getElementById("quizLast");
  const quizHint = document.getElementById("quizHint");

  // helpers
  function iso(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function addDays(isoStr, days){
    const d = new Date(isoStr + "T00:00:00");
    d.setDate(d.getDate() + days);
    return iso(d);
  }
  function fmtThai(isoStr){
    if(!isoStr) return "-";
    return new Date(isoStr + "T00:00:00").toLocaleDateString("th-TH", { year:"numeric", month:"long", day:"numeric" });
  }
  function clampInt(v, min, max, def){
    if(!Number.isFinite(v)) return def;
    return Math.max(min, Math.min(max, Math.round(v)));
  }

  // A) Family Planning (localStorage)
  const FP_LS_KEY = "FEMI_FAMILY_PLANNING_LOCAL_V2";
  function readFp(){
    try{
      const raw = localStorage.getItem(FP_LS_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  }
  function computeFpPrediction(state){
    const cycles = Array.isArray(state?.cycles) ? state.cycles.slice() : [];
    if(!cycles.length) return null;
    cycles.sort((a,b)=> String(b.start||"").localeCompare(String(a.start||"")));
    const latest = cycles[0];

    const start = latest.start;
    const cycleLen = clampInt(Number(latest.cycleLen || state?.settings?.cycleLen || 28), 20, 45, 28);
    const periodLen = clampInt(Number(latest.periodLen || state?.settings?.periodLen || 5), 2, 10, 5);

    const nextStart = addDays(start, cycleLen);
    const ovulation = addDays(nextStart, -14);
    const fertileStart = addDays(ovulation, -5);
    const fertileEnd = ovulation;
    const periodStart = start;
    const periodEnd = addDays(start, periodLen-1);

    return { start, cycleLen, periodLen, nextStart, ovulation, fertileStart, fertileEnd, periodStart, periodEnd };
  }
  function countLogsThisMonth(logs){
    const now = new Date();
    const from = iso(new Date(now.getFullYear(), now.getMonth(), 1));
    const to = iso(new Date(now.getFullYear(), now.getMonth()+1, 0));
    return Object.keys(logs||{}).filter(d => d >= from && d <= to).length;
  }

  const fp = readFp();
  if(!fp || !Array.isArray(fp.cycles) || fp.cycles.length === 0){
    fpCyclesEl.textContent = "0";
    fpLogsEl.textContent = "0";
    fpPredText.textContent = "ยังไม่มีข้อมูลคาดการณ์ • ไปเพิ่มรอบเดือนก่อน";
    fpPredDetail.innerHTML = "";
    streak7.textContent = "0 วัน";
  }else{
    fpCyclesEl.textContent = String(fp.cycles.length);
    fpLogsEl.textContent = String(countLogsThisMonth(fp.logs));

    const pred = computeFpPrediction(fp);
    if(!pred){
      fpPredText.textContent = "ยังไม่มีข้อมูลคาดการณ์ • ไปเพิ่มรอบเดือนก่อน";
      fpPredDetail.innerHTML = "";
    }else{
      fpPredText.textContent =
        `รอบที่ใช้คำนวณเริ่ม: ${fmtThai(pred.start)} • รอบเฉลี่ย ${pred.cycleLen} วัน • มาประมาณ ${pred.periodLen} วัน`;
      fpPredDetail.innerHTML =
        `<div class="pred-line"><b>รอบถัดไปคาดว่าจะมา:</b> ${fmtThai(pred.nextStart)}</div>` +
        `<div class="pred-line"><b>ช่วงเสี่ยงท้อง:</b> ${fmtThai(pred.fertileStart)} – ${fmtThai(pred.fertileEnd)}</div>` +
        `<div class="pred-line"><b>วันไข่ตก (โดยประมาณ):</b> ${fmtThai(pred.ovulation)}</div>` +
        `<div class="pred-line"><b>ช่วงประจำเดือน (รอบนี้):</b> ${fmtThai(pred.periodStart)} – ${fmtThai(pred.periodEnd)}</div>`;
    }

    const now = new Date();
    const to = iso(now);
    const from = iso(new Date(now.getFullYear(), now.getMonth(), now.getDate()-6));
    const set = new Set(Object.keys(fp.logs||{}).filter(d => d >= from && d <= to));
    streak7.textContent = `${set.size} วัน`;
  }

  // B) Health checklist (localStorage)
  const HC_LS_KEY = "FEMI_HEALTH_CHECKLIST_V1";
  const CHECKS = [
    { id:"bp", scope:["basic","metabolic"], minAge:15, intervalMonths:12 },
    { id:"bmi_waist", scope:["basic","metabolic"], minAge:15, intervalMonths:12 },
    { id:"fbs_hba1c", scope:["metabolic"], minAge:35, intervalMonths:12 },
    { id:"lipid", scope:["metabolic"], minAge:35, intervalMonths:12 },
    { id:"cervical", scope:["women","cancer"], minAge:21, intervalMonths:36 },
    { id:"breast_clinical", scope:["women","cancer"], minAge:20, intervalMonths:12 },
    { id:"dental", scope:["basic"], minAge:15, intervalMonths:12 },
    { id:"eye", scope:["basic"], minAge:18, intervalMonths:24 },
    { id:"mental", scope:["mental"], minAge:15, intervalMonths:12 },
    { id:"flu", scope:["basic"], minAge:15, intervalMonths:12 },
  ];
  function loadHc(){
    try{
      const raw = localStorage.getItem(HC_LS_KEY);
      return raw ? JSON.parse(raw) : { age: "", scope:"all", items:{} };
    }catch{
      return { age: "", scope:"all", items:{} };
    }
  }
  function ymToday(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return { iso: `${yyyy}-${mm}-${dd}` };
  }
  function addMonths(dateIso, months){
    const d = new Date(dateIso + "T00:00:00");
    const nd = new Date(d.getFullYear(), d.getMonth() + months, d.getDate());
    const yyyy = nd.getFullYear();
    const mm = String(nd.getMonth()+1).padStart(2,"0");
    const dd = String(nd.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function isBefore(aIso, bIso){
    return new Date(aIso+"T00:00:00").getTime() < new Date(bIso+"T00:00:00").getTime();
  }
  function getItemStatus(item, rec){
    const today = ymToday().iso;
    if(!rec || !rec.status || rec.status === "todo"){
      return { state:"todo", pillText:"ถึงกำหนด", due:true };
    }
    const last = rec.date || "";
    if(!last){
      return { state:"done", pillText:"ครบแล้ว", due:false };
    }
    const nextDue = addMonths(last, item.intervalMonths || 12);
    if(isBefore(nextDue, today)){
      const overMark = addMonths(nextDue, 3);
      const isOver = isBefore(overMark, today);
      return { state:"done", pillText: isOver ? "เกินกำหนด" : "ถึงกำหนด", due:true };
    }
    return { state:"done", pillText:"ครบแล้ว", due:false };
  }
  function inAge(item, age){
    const a = Number(age);
    if(!Number.isFinite(a) || !age) return true;
    if(item.minAge != null && a < item.minAge) return false;
    return true;
  }
  function inScope(item, scope){
    if(scope === "all") return true;
    return (item.scope || []).includes(scope);
  }

  const hc = loadHc();
  const filtered = CHECKS
    .filter(it => inAge(it, hc.age ?? ""))
    .filter(it => inScope(it, hc.scope ?? "all"))
    .map(it => ({ st: getItemStatus(it, hc.items?.[it.id]) }));

  const total = filtered.length;
  const dueCount = filtered.filter(x => x.st.due).length;
  const doneCount = filtered.filter(x => x.st.state === "done").length;
  const overCount = filtered.filter(x => x.st.pillText === "เกินกำหนด").length;

  hcAllEl.textContent = String(total);
  hcDueEl.textContent = String(dueCount);
  hcDoneEl.textContent = String(doneCount);
  hcHintEl.textContent = overCount > 0
    ? `เกินกำหนด ${overCount} รายการ • ไปที่ “ตารางวางแผนตรวจสุขภาพทั้งปี” เพื่อดูรายละเอียด`
    : `ไปที่ “ตารางวางแผนตรวจสุขภาพทั้งปี” เพื่อดูรายละเอียด`;

  // C) Quiz (API, guard)
  try{
    if(api && typeof api.quizMyResults === "function"){
      const res = await api.quizMyResults();
      const arr = Array.isArray(res) ? res : (Array.isArray(res?.items) ? res.items : []);
      const last = arr[0] || null;
      quizLast.textContent = last ? `${last.score}/${last.total}` : "-";
      quizHint.textContent = last
        ? (last.takenAt ? ("ทำล่าสุด: " + new Date(last.takenAt).toLocaleString("th-TH",{dateStyle:"medium",timeStyle:"short"})) : "")
        : "ยังไม่มีคะแนน";
    }else{
      quizLast.textContent = "-";
      quizHint.textContent = "ยังไม่มีคะแนน";
    }
  }catch{
    quizLast.textContent = "-";
    quizHint.textContent = "ยังไม่มีคะแนน";
  }
</script>
</body>
</html>